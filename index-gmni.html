<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Siena395 MASTER ULTRA v1.0.24</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <style>
        :root {
            --bg: #a0aec0; --card: #cbd5e0; --text: #1a202c; --accent: #3182ce;
            --solar: #d69e2e; --battery: #38a169; --danger: #e53e3e; --border: #718096; 
            --radius: 18px;
        }
        .dark-mode { --bg: #1a202c; --card: #2d3748; --text: #f7fafc; --border: #4a5568; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; transition: 0.3s; }
        body { background-color: var(--bg); color: var(--text); padding: 15px; display: flex; justify-content: center; }
        .dashboard { display: grid; grid-template-columns: repeat(auto-fit, minmax(340px, 1fr)); gap: 15px; max-width: 1200px; width: 100%; }
        header { grid-column: 1 / -1; display: flex; justify-content: space-between; align-items: center; padding: 5px; }
        .card { background: var(--card); border-radius: var(--radius); padding: 18px; border: 1px solid var(--border); border-left: 6px solid var(--accent); box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .c-battery { border-left-color: var(--battery); }
        .c-bms { border-left-color: #805ad5; }
        .c-solar { border-left-color: var(--solar); }
        .badge { padding: 4px 12px; border-radius: 20px; font-size: 0.7rem; font-weight: 900; color: white; text-transform: uppercase; }
        .bg-on { background: var(--battery); } .bg-off { background: var(--danger); }
        .flow-section { grid-column: 1 / -1; height: 320px; position: relative; background: var(--card); border-left: none !important; border-radius: var(--radius); overflow: hidden; }
        #flowCanvas { width: 100%; height: 100%; }
        .node { position: absolute; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 0.6rem; font-weight: 800; width: 75px; height: 75px; z-index: 2; border-radius: 50%; background: var(--card); border: 3px solid var(--border); }
        .n-solar { top: 10%; left: 15%; border-color: var(--solar); }
        .n-battery { top: 50%; left: 50%; transform: translate(-50%, -50%); border-color: var(--battery); width: 95px; height: 95px; }
        .n-inverter { top: 10%; right: 15%; border-color: var(--accent); }
        .soc-big { font-size: 3.5rem; font-weight: 900; text-align: center; color: var(--battery); letter-spacing: -2px; }
        .stats-grid-4 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .stat-item { background: rgba(0,0,0,0.05); padding: 10px; border-radius: 12px; text-align: center; }
        .val { display: block; font-size: 1.1rem; font-weight: 900; }
        .lab { font-size: 0.6rem; font-weight: 700; opacity: 0.7; text-transform: uppercase; }
        .cell-row { display: flex; align-items: center; gap: 8px; margin-bottom: 5px; }
        .cell-bar-bg { flex-grow: 1; height: 8px; background: rgba(0,0,0,0.1); border-radius: 4px; overflow: hidden; }
        .cell-bar-fill { height: 100%; width: 0%; background: var(--battery); transition: 0.5s; }
        #logContainer { background: #1a202c; color: #48bb78; font-family: monospace; font-size: 0.65rem; height: 120px; overflow-y: auto; padding: 10px; border-radius: 8px; }
    </style>
</head>
<body class="dark-mode">

<div class="dashboard">
    <header>
        <h1 style="font-size: 1.2rem;">SIENA395 <span style="color:var(--accent)">MASTER ULTRA</span></h1>
        <span id="mqttStatus" class="badge bg-off">DESCONECTADO</span>
    </header>

    <section class="card flow-section">
        <canvas id="flowCanvas"></canvas>
        <div class="node n-solar"><i class="fas fa-sun" style="color:var(--solar)"></i><span>Solar</span></div>
        <div class="node n-battery"><span id="socMini" style="font-size:1.2rem">--%</span><span>BATERÍA</span></div>
        <div class="node n-inverter"><i class="fas fa-plug" style="color:var(--accent)"></i><span>Phoenix</span></div>
    </section>

    <section class="card c-battery">
        <div style="font-size:0.75rem; font-weight:900; margin-bottom:10px;"><i class="fas fa-car-battery"></i> SHUNT VICTRON</div>
        <div id="socValue" class="soc-big">--%</div>
        <div class="stats-grid-4">
            <div class="stat-item"><span class="val" id="vBat">--V</span><span class="lab">Tensión</span></div>
            <div class="stat-item"><span class="val" id="iBat">--A</span><span class="lab">Corriente</span></div>
        </div>
    </section>

    <section class="card c-bms">
        <div style="font-size:0.75rem; font-weight:900; margin-bottom:10px;"><i class="fas fa-bluetooth"></i> BMS ULTIMATRON BLE</div>
        <div class="stats-grid-4">
            <div class="stat-item"><span class="val" id="bmsSoc">--%</span><span class="lab">SOC BMS</span></div>
            <div class="stat-item"><span class="val" id="bmsV">--V</span><span class="lab">Tensión</span></div>
            <div class="stat-item"><span class="val" id="bmsI">--A</span><span class="lab">Corriente</span></div>
            <div class="stat-item"><span class="val" id="bmsT">--°C</span><span class="lab">Temp. BMS</span></div>
        </div>
        <div id="cellList" style="margin-top:15px; border-top:1px solid var(--border); padding-top:10px;"></div>
    </section>

    <section class="card" style="border-left-color: #4fd1c5;">
        <div style="font-size:0.75rem; font-weight:900; margin-bottom:10px;"><i class="fas fa-thermometer-half"></i> BATTERY SENSE</div>
        <div class="stats-grid-4">
            <div class="stat-item"><span class="val" id="btsV">--V</span><span class="lab">Voltaje</span></div>
            <div class="stat-item"><span class="val" id="btsT">--°C</span><span class="lab">Temp. Real</span></div>
        </div>
    </section>

    <section class="card">
        <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
            <span style="font-size:0.75rem; font-weight:900;">PHOENIX INVERTER</span>
            <span id="invMode" class="badge bg-off">OFF</span>
        </div>
        <div class="stat-item"><span class="val" id="invVA">--VA</span><span class="lab">Consumo AC</span></div>
    </section>

    <section class="card c-solar">
        <div style="font-size:0.75rem; font-weight:900; margin-bottom:10px;"><i class="fas fa-sun"></i> SMARTSOLAR MPPT</div>
        <div class="stats-grid-4">
            <div class="stat-item" style="grid-column: 1/-1;"><span class="val" id="solW">--W</span><span class="lab">Carga Solar</span></div>
            <div class="stat-item"><span class="val" id="solV">--V</span><span class="lab">V. Panel</span></div>
            <div class="stat-item"><span class="val" id="solVbat">--V</span><span class="lab">V. Batería</span></div>
        </div>
    </section>

    <section class="card" style="grid-column: 1 / -1;">
        <div class="chart-container" style="height:180px;"><canvas id="histChart"></canvas></div>
    </section>

    <section class="card" style="grid-column: 1 / -1;">
        <div id="logContainer">Conectando...</div>
    </section>
</div>

<script>
    const client = mqtt.connect('wss://broker.emqx.io:8084/mqtt');
    let pSolar = 0, pInv = 0;

    const cellList = document.getElementById('cellList');
    for(let i=1; i<=4; i++) {
        cellList.innerHTML += `<div class="cell-row"><div style="font-size:0.6rem; width:30px;">C${i}</div><div class="cell-bar-bg"><div id="bar${i}" class="cell-bar-fill"></div></div><div id="vCell${i}" style="font-size:0.7rem; font-weight:900; width:50px;">-.--V</div></div>`;
    }

    const socChart = new Chart(document.getElementById('histChart'), {
        type: 'line',
        data: { labels: [], datasets: [{ label: 'SOC', data: [], borderColor: '#38a169', fill: true, backgroundColor: 'rgba(56, 161, 105, 0.1)', pointRadius: 0 }] },
        options: { responsive: true, maintainAspectRatio: false, scales: { y: { min: 0, max: 100 }, x: { display: false } }, plugins: { legend: { display: false } } }
    });

    client.on('connect', () => {
        document.getElementById('mqttStatus').innerText = "CONECTADO";
        document.getElementById('mqttStatus').className = "badge bg-on";
        client.subscribe('siena395_monitor_mikel_2026/#');
    });

    client.on('message', (topic, msg) => {
        const val = parseFloat(msg.toString());
        const t = topic.toLowerCase();
        const sensor = topic.split('/').pop();

        // LOG
        const log = document.getElementById('logContainer');
        log.innerHTML = `<div>[${new Date().toLocaleTimeString()}] <b>${sensor}</b>: ${msg.toString()}</div>` + log.innerHTML;
        if(log.children.length > 5) log.lastChild.remove();

        // --- MAPEADO CORREGIDO SEGÚN TUS CAPTURAS ---
        
        // SOC (Shunt y BMS)
        if(sensor === 'porcentaje_bateria' || sensor.includes('soc')) {
            document.getElementById('socValue').innerText = Math.round(val)+'%';
            document.getElementById('socMini').innerText = Math.round(val)+'%';
            document.getElementById('bmsSoc').innerText = Math.round(val)+'%';
            socChart.data.labels.push(""); socChart.data.datasets[0].data.push(val);
            if(socChart.data.labels.length > 40) { socChart.data.labels.shift(); socChart.data.datasets[0].data.shift(); }
            socChart.update();
        }

        // Voltajes (Detectando origen por el topic completo)
        if(sensor === 'voltaje_bateria') {
            document.getElementById('vBat').innerText = val.toFixed(2)+'V';
            if(t.includes('bms')) document.getElementById('bmsV').innerText = val.toFixed(2)+'V';
        }
        
        // Corriente
        if(sensor === 'corriente_bateria') document.getElementById('iBat').innerText = val.toFixed(1)+'A';
        if(sensor === 'bms_corriente' || (t.includes('bms') && sensor.includes('corriente'))) {
            document.getElementById('bmsI').innerText = val.toFixed(1)+'A';
        }

        // Temperatura
        if(sensor.includes('temperatura')) {
            document.getElementById('btsT').innerText = val.toFixed(1)+'°C';
            if(t.includes('bms')) document.getElementById('bmsT').innerText = val.toFixed(1)+'°C';
        }

        // Sense
        if(sensor === 'voltaje_sense') document.getElementById('btsV').innerText = val.toFixed(2)+'V';

        // Celdas (Nombre exacto del log: cell_voltage_1)
        if(sensor.includes('cell_voltage_')) {
            const n = sensor.split('_').pop();
            if(n >= 1 && n <= 4) {
                document.getElementById(`vCell${n}`).innerText = val.toFixed(3)+'V';
                const pct = ((val - 2.8) / (3.65 - 2.8)) * 100;
                document.getElementById(`bar${n}`).style.width = Math.min(Math.max(pct, 0), 100) + '%';
            }
        }

        // Solar e Inversor
        if(sensor.includes('potencia_solar')) { document.getElementById('solW').innerText = Math.round(val)+'W'; pSolar = val; }
        if(sensor.includes('voltaje_paneles')) document.getElementById('solV').innerText = val.toFixed(1)+'V';
        if(sensor.includes('voltaje_bateria_mppt')) document.getElementById('solVbat').innerText = val.toFixed(2)+'V';
        if(sensor.includes('potencia_salida_phoenix')) {
            document.getElementById('invVA').innerText = Math.round(val)+'VA';
            pInv = val;
            document.getElementById('invMode').innerText = val > 5 ? "ON" : "OFF";
            document.getElementById('invMode').className = val > 5 ? "badge bg-on" : "badge bg-off";
        }
    });

    // Animación de flujo
    const canvas = document.getElementById('flowCanvas');
    const ctx = canvas.getContext('2d');
    let w, h;
    function res() { w=canvas.width=canvas.offsetWidth; h=canvas.height=canvas.offsetHeight; }
    function draw() {
        ctx.clearRect(0,0,w,h);
        const time = Date.now()*0.002;
        const pts = { s:{x:w*0.15+35, y:h*0.1+35}, b:{x:w*0.5, y:h*0.5}, i:{x:w*0.85-35, y:h*0.1+35} };
        function line(f,t,act,col) {
            if(!act) return;
            ctx.beginPath(); ctx.setLineDash([5,10]); ctx.lineDashOffset=-time*20;
            ctx.strokeStyle=col; ctx.lineWidth=2; ctx.moveTo(f.x,f.y); ctx.lineTo(t.x,t.y); ctx.stroke();
        }
        line(pts.s, pts.b, pSolar > 5, 'var(--solar)');
        line(pts.b, pts.i, pInv > 10, 'var(--danger)');
        requestAnimationFrame(draw);
    }
    window.onresize=res; res(); draw();
</script>
</body>
</html>
