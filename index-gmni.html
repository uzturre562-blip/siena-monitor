<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SIENA395 MASTER PRO (v1.0.14)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <style>
        :root {
            --bg: #a0aec0; --card: #cbd5e0; --item-bg: rgba(255,255,255,0.4); 
            --text: #1a202c; --accent: #3182ce;
            --solar: #d69e2e; --battery: #38a169; --danger: #e53e3e; --border: #718096; 
            --radius: 18px;
        }
        .dark-mode { 
            --bg: #1a202c; --card: #2d3748; --item-bg: #3d495d; 
            --text: #f7fafc; --border: #4a5568; 
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; transition: 0.2s; }
        body { background-color: var(--bg); color: var(--text); padding: 15px; display: flex; flex-direction: column; align-items: center; }
        .dashboard { display: grid; grid-template-columns: repeat(auto-fit, minmax(340px, 1fr)); gap: 15px; max-width: 1200px; width: 100%; }
        header { grid-column: 1 / -1; display: flex; justify-content: space-between; align-items: center; padding: 10px; background: var(--card); border-radius: 12px; border: 1px solid var(--border); }
        .card { background: var(--card); border-radius: var(--radius); padding: 18px; border: 1px solid var(--border); border-left: 6px solid var(--accent); box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .card.c-battery { border-left-color: var(--battery); }
        .card.c-bms { border-left-color: #805ad5; } 
        .card.c-sense { border-left-color: #4fd1c5; }
        .soc-big { font-size: 3.5rem; font-weight: 900; text-align: center; margin: 5px 0; color: var(--battery); letter-spacing: -2px; }
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .stat-item { background: var(--item-bg); padding: 12px; border-radius: 12px; text-align: center; }
        .val { display: block; font-size: 1.2rem; font-weight: 900; }
        .lab { font-size: 0.65rem; font-weight: 700; text-transform: uppercase; opacity: 0.8; }
        .card-title { font-size: 0.8rem; font-weight: 900; text-transform: uppercase; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
        .cell-container { margin-top: 10px; border-top: 1px solid var(--border); padding-top: 10px; }
        .cell-row { display: flex; align-items: center; gap: 8px; margin-bottom: 4px; }
        .cell-bar-bg { flex-grow: 1; height: 10px; background: rgba(0,0,0,0.2); border-radius: 5px; overflow: hidden; }
        .cell-bar-fill { height: 100%; width: 0%; background: var(--battery); transition: 1s; }
        #logContainer { background: #1a202c; color: #48bb78; font-family: monospace; font-size: 0.7rem; height: 120px; overflow-y: auto; padding: 10px; border-radius: 8px; }
    </style>
</head>
<body class="dark-mode">

<div class="dashboard">
    <header>
        <h1 style="font-size: 1.1rem;">SIENA395 <span style="color:var(--accent)">MASTER PRO</span></h1>
        <div id="mqttStatus" style="padding:4px 10px; border-radius:20px; font-size:0.7rem; background:var(--danger); color:white;">DESCONECTADO</div>
    </header>

    <section class="card c-battery">
        <div class="card-title"><i class="fas fa-bolt"></i> SmartShunt 500A</div>
        <div id="socValue" class="soc-big">--%</div>
        <div class="stats-grid">
            <div class="stat-item"><span class="val" id="vBat">--V</span><span class="lab">Tensión</span></div>
            <div class="stat-item"><span class="val" id="iBat">--A</span><span class="lab">Corriente</span></div>
        </div>
    </section>

    <section class="card c-sense">
        <div class="card-title"><i class="fas fa-temperature-high"></i> Victron Battery Sense</div>
        <div class="stats-grid">
            <div class="stat-item"><span class="val" id="vSense">--V</span><span class="lab">Voltios Batería</span></div>
            <div class="stat-item"><span class="val" id="tSense">--°C</span><span class="lab">Temperatura</span></div>
        </div>
    </section>

    <section class="card c-bms">
        <div class="card-title"><i class="fas fa-microchip"></i> BMS Ultimatron 100Ah</div>
        <div class="stats-grid">
            <div class="stat-item"><span class="val" id="bmsSoc">--%</span><span class="lab">SOC BMS</span></div>
            <div class="stat-item"><span class="val" id="bmsV">--V</span><span class="lab">Total BMS</span></div>
            <div class="stat-item"><span class="val" id="bmsI">--A</span><span class="lab">Amperios</span></div>
            <div class="stat-item"><span class="val" id="bmsT">--°C</span><span class="lab">Temp BMS</span></div>
        </div>
        <div class="cell-container" id="cellList"></div>
    </section>

    <section class="card" style="grid-column: 1 / -1;">
        <div class="card-title">Terminal MQTT</div>
        <div id="logContainer">Esperando datos...</div>
    </section>
</div>

<script>
    const client = mqtt.connect('wss://broker.emqx.io:8084/mqtt');

    // Inicializar celdas
    const cellList = document.getElementById('cellList');
    for(let i=1; i<=4; i++) {
        cellList.innerHTML += `
            <div class="cell-row" style="font-size:0.75rem;">
                <div style="width:25px">C${i}</div>
                <div class="cell-bar-bg"><div id="bar${i}" class="cell-bar-fill"></div></div>
                <div id="vCell${i}" style="width:55px; text-align:right; font-weight:800;">-.---V</div>
            </div>`;
    }

    client.on('connect', () => { 
        document.getElementById('mqttStatus').innerText = "CONECTADO";
        document.getElementById('mqttStatus').style.background = "var(--battery)";
        // Suscribirse a la raíz del proyecto para captar todo
        client.subscribe('siena395_monitor_mikel_2026/#'); 
    });

    client.on('message', (topic, msg) => {
        const val = parseFloat(msg.toString());
        const rawTopic = topic.split('/');
        const sensor = rawTopic[rawTopic.length - 1];
        const category = rawTopic[rawTopic.length - 2];

        // LOG para depurar
        const log = document.getElementById('logContainer');
        log.innerHTML = `<div>[${category}] <b>${sensor}</b>: ${val}</div>` + log.innerHTML;
        if(log.children.length > 5) log.lastChild.remove();

        // --- MAPEO SEGÚN TUS ARCHIVOS YAML ---

        // 1. Datos desde siena395.yaml (Carpeta /sensor/)
        if(category === 'sensor') {
            if(sensor === 'voltaje_bateria') document.getElementById('vBat').innerText = val.toFixed(2)+'V';
            if(sensor === 'porcentaje_bateria') {
                document.getElementById('socValue').innerText = Math.round(val)+'%';
            }
            if(sensor === 'corriente_bateria') document.getElementById('iBat').innerText = val.toFixed(2)+'A';
            if(sensor === 'temperatura_bateria') document.getElementById('tSense').innerText = val.toFixed(1)+'°C';
            // Nota: En tu YAML el voltaje_sense no tiene mqtt publish, pero si lo añades usa esto:
            if(sensor === 'voltaje_sense') document.getElementById('vSense').innerText = val.toFixed(2)+'V';
        }

        // 2. Datos desde siena395_bms.yaml (Carpeta /bms/)
        if(category === 'bms') {
            if(sensor === 'soc') document.getElementById('bmsSoc').innerText = Math.round(val)+'%';
            if(sensor === 'voltaje') document.getElementById('bmsV').innerText = val.toFixed(2)+'V';
            if(sensor === 'corriente') document.getElementById('bmsI').innerText = val.toFixed(2)+'A';
            if(sensor === 'temp') document.getElementById('bmsT').innerText = val.toFixed(1)+'°C';
        }

        // 3. Celdas (Captura si el sensor contiene 'cell_voltage' o 'bms_celda')
        if(sensor.includes('cell_voltage') || sensor.includes('bms_celda')) {
            const n = sensor.split('_').pop();
            if(n >= 1 && n <= 4) {
                document.getElementById(`vCell${n}`).innerText = val.toFixed(3)+'V';
                const pct = ((val - 2.8) / (3.65 - 2.8)) * 100;
                document.getElementById(`bar${n}`).style.width = Math.min(Math.max(pct,0),100)+'%';
            }
        }
    });
</script>
</body>
</html>
