<!DOCTYPE html>
<html lang="es" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üöê Monitor Victron PRO - Siena395</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    
    <style>
        :root {
            --primary: #667eea; --secondary: #764ba2; --success: #10b981;
            --warning: #f59e0b; --danger: #ef4444; --caravan: #f97316;
            --bg-color: #f5f7fa; --card-bg: #ffffff; --text-color: #333333;
        }
        [data-theme="dark"] {
            --bg-color: #1a1a2e; --card-bg: #16213e; --text-color: #e0e0e0;
        }
        body { background: var(--bg-color); color: var(--text-color); transition: 0.3s; padding-top: 20px; }
        .dashboard-card { background: var(--card-bg); border-radius: 15px; box-shadow: 0 8px 16px rgba(0,0,0,0.1); margin-bottom: 20px; border: none; }
        .card-header { background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; border: none; font-weight: bold; }
        .sensor-value { font-size: 2.2rem; font-weight: bold; color: var(--primary); }
        .mini-label { font-size: 0.8rem; color: #888; text-transform: uppercase; }
        .status-badge { padding: 4px 12px; border-radius: 15px; font-size: 0.75rem; font-weight: bold; }
    </style>
</head>
<body>

    <div class="container">
        <div class="row mb-4">
            <div class="col-8">
                <h1 class="fw-bold"><i class="fas fa-caravan" style="color:var(--caravan)"></i> Siena395 Monitor</h1>
                <span id="esp-status" class="status-badge bg-danger text-white">OFFLINE</span>
            </div>
            <div class="col-4 text-end">
                <button id="themeToggle" class="btn btn-sm btn-outline-secondary">
                    <i class="fas fa-moon"></i>
                </button>
            </div>
        </div>

        <div class="row">
            <div class="col-md-6 col-xl-4">
                <div class="card dashboard-card">
                    <div class="card-header"><i class="fas fa-battery-full me-2"></i>SmartShunt</div>
                    <div class="card-body text-center">
                        <div class="sensor-value" id="soc_smartshunt">--%</div>
                        <div class="progress mb-2" style="height: 10px;"><div id="soc_bar" class="progress-bar bg-success" style="width: 0%"></div></div>
                        <div class="row">
                            <div class="col-6"><span class="mini-label">Voltios</span><div id="voltage_smartshunt">--.-V</div></div>
                            <div class="col-6"><span class="mini-label">Amperios</span><div id="current_smartshunt">--.-A</div></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-6 col-xl-4">
                <div class="card dashboard-card">
                    <div class="card-header bg-warning text-dark"><i class="fas fa-sun me-2"></i>MPPT Solar</div>
                    <div class="card-body text-center">
                        <div class="sensor-value text-warning" id="power_mppt">-- W</div>
                        <div class="row">
                            <div class="col-6"><span class="mini-label">Panel</span><div id="voltage_mppt">--.-V</div></div>
                            <div class="col-6"><span class="mini-label">Carga</span><div id="battery_voltage_mppt">--.-V</div></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-6 col-xl-4">
                <div class="card dashboard-card">
                    <div class="card-header bg-info text-white"><i class="fas fa-truck-moving me-2"></i>Orion DC-DC</div>
                    <div class="card-body text-center">
                        <div class="sensor-value" style="color:#0dcaf0" id="orion_input_voltage">--.-V</div>
                        <span class="mini-label">Voltaje Entrada (Alternador)</span>
                        <div class="mt-2 h5" id="orion_output_voltage">Salida: --.-V</div>
                    </div>
                </div>
            </div>

            <div class="col-md-6 col-xl-4">
                <div class="card dashboard-card">
                    <div class="card-header bg-primary text-white"><i class="fas fa-plug me-2"></i>Inversor 220V</div>
                    <div class="card-body text-center">
                        <div class="sensor-value" id="inverter_voltage">--.-V</div>
                        <div class="badge bg-secondary" id="inverter_state">Estado: --</div>
                    </div>
                </div>
            </div>

            <div class="col-md-6 col-xl-4">
                <div class="card dashboard-card">
                    <div class="card-header bg-danger text-white"><i class="fas fa-thermometer-half me-2"></i>Battery Sense</div>
                    <div class="card-body text-center">
                        <div class="sensor-value text-danger" id="battery_temp_sensor">--¬∞C</div>
                        <div class="mini-label">Temp. Ultimatron</div>
                        <div id="battery_voltage_sense">--.-V</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-12"><div class="card dashboard-card p-3"><canvas id="mainChart" height="100"></canvas></div></div>
        </div>
    </div>

    <script>
        const BROKER = "wss://broker.emqx.io:8084/mqtt";
        const PREFIX = "siena395_monitor_mikel_2026";
        const client = mqtt.connect(BROKER);
        let chart;

        // MODO OSCURO
        const themeToggle = document.getElementById('themeToggle');
        themeToggle.onclick = () => {
            const current = document.documentElement.getAttribute('data-theme');
            const target = current === 'light' ? 'dark' : 'light';
            document.documentElement.setAttribute('data-theme', target);
            themeToggle.innerHTML = target === 'light' ? '<i class="fas fa-moon"></i>' : '<i class="fas fa-sun"></i>';
        };

        client.on('connect', () => {
            client.subscribe(`${PREFIX}/#`);
            console.log("Conectado a EMQX - Siena 395 Full");
        });

        client.on('message', (topic, message) => {
            const val = message.toString();
            const id = topic.split('/')[2];

            if (topic === `${PREFIX}/status`) {
                const b = document.getElementById('esp-status');
                b.innerText = val.toUpperCase();
                b.className = val === 'online' ? "status-badge bg-success text-white" : "status-badge bg-danger text-white";
                return;
            }

            const el = document.getElementById(id);
            if (!el) return;

            // L√≥gica de visualizaci√≥n por tipo de sensor
            if (id.includes('soc')) {
                el.innerText = parseFloat(val).toFixed(1) + '%';
                document.getElementById('soc_bar').style.width = val + '%';
            } else if (id.includes('temp')) {
                el.innerText = parseFloat(val).toFixed(1) + '¬∞C';
            } else if (id.includes('power')) {
                el.innerText = Math.round(val) + ' W';
            } else if (id === 'inverter_state') {
                el.innerText = 'Estado: ' + val;
            } else {
                el.innerText = parseFloat(val).toFixed(2) + 'V';
                if (id === 'voltage_smartshunt') addDataToChart(parseFloat(val));
            }
        });

        function initChart() {
            const ctx = document.getElementById('mainChart').getContext('2d');
            chart = new Chart(ctx, {
                type: 'line',
                data: { labels: [], datasets: [{ label: 'Voltaje Bater√≠a', data: [], borderColor: '#667eea', tension: 0.4 }] },
                options: { scales: { y: { min: 12.5, max: 14.6 } } }
            });
        }

        function addDataToChart(v) {
            if (!chart) return;
            const now = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            chart.data.labels.push(now);
            chart.data.datasets[0].data.push(v);
            if (chart.data.labels.length > 15) { chart.data.labels.shift(); chart.data.datasets[0].data.shift(); }
            chart.update();
        }

        window.onload = initChart;
    </script>
</body>
</html>
