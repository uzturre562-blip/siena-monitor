<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Siena 395 - Dashboard Principal</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mqtt/4.3.7/mqtt.min.js"></script>
    
    <style>
        :root {
            --bg-primary: #f8f5f0;
            --bg-secondary: #fefcf8;
            --text-main: #2c2925;
            --accent-primary: #8b7355;
            --victron-blue: #1a5c96;
            --victron-blue-light: #2c7ab1;
            --solar-orange: #f39c12;
            --grid-blue: #3498db;
            --consumer-red: #e67e22;
            --battery-green: #27ae60;
            --success: #27ae60;
            --warning: #e67e22;
            --danger: #e74c3c;
            --card-radius: 24px;
            --border-light: #e2ddd5;
        }

        /* Modo oscuro */
        body.dark-mode {
            --bg-primary: #121417;
            --bg-secondary: #1a1d23;
            --text-main: #e0e0e0;
            --border-light: #2d343f;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-primary);
            color: var(--text-main);
            margin: 0;
            transition: background-color 0.3s, color 0.3s;
        }

        /* --- MEN√ö DE NAVEGACI√ìN --- */
        .nav-master {
            display: flex;
            justify-content: center;
            gap: 10px;
            padding: 15px;
            background: var(--bg-secondary);
            position: sticky;
            top: 0;
            z-index: 1000;
            border-bottom: 1px solid var(--border-light);
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        }

        .nav-btn {
            background: var(--bg-primary);
            border: 2px solid var(--border-light);
            padding: 8px 12px;
            border-radius: 12px;
            font-weight: 700;
            color: #888;
            text-decoration: none;
            font-size: 0.8rem;
            transition: all 0.2s ease;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .nav-btn.active {
            background: var(--accent-primary);
            color: white;
            border-color: var(--accent-primary);
        }

        /* Estilos del Dashboard */
        .dashboard { max-width: 800px; margin: 0 auto; padding: 15px; }
        
        .card {
            background: var(--bg-secondary);
            border-radius: var(--card-radius);
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.05);
            border: 1px solid var(--border-light);
            transition: background-color 0.3s, border-color 0.3s;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 0 10px;
        }
        
        .header h1 {
            font-size: 1.4rem;
            font-weight: 900;
            margin: 0;
            color: var(--accent-primary);
        }

        /* Indicadores de flujo */
        .flow-grid {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 15px;
        }

        .flow-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px dashed var(--border-light);
        }

        .flow-label {
            font-weight: 600;
            color: #888;
            font-size: 0.9rem;
        }

        .flow-label i {
            width: 24px;
            color: var(--accent-primary);
        }

        .flow-value {
            font-weight: 800;
            font-size: 1.2rem;
        }

        .value-green { color: var(--battery-green); }
        .value-orange { color: var(--solar-orange); }
        .value-blue { color: var(--grid-blue); }
        .value-red { color: var(--consumer-red); }

        /* Mini tarjetas de resumen */
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: var(--bg-secondary);
            border-radius: 20px;
            padding: 15px;
            text-align: center;
            border: 1px solid var(--border-light);
        }

        .stat-label {
            font-size: 0.7rem;
            font-weight: 700;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-value {
            font-size: 1.8rem;
            font-weight: 900;
            line-height: 1.2;
        }

        .stat-unit {
            font-size: 0.8rem;
            font-weight: 500;
            color: #888;
            margin-left: 2px;
        }

        .button-large {
            padding: 15px;
            font-size: 1rem;
            justify-content: space-between;
            width: 100%;
        }

        /* Bot√≥n modo oscuro */
        .theme-switch {
            position: fixed;
            bottom: 25px;
            right: 25px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--accent-primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            z-index: 2000;
            border: none;
            font-size: 1.5rem;
        }

        .badge {
            background: var(--bg-primary);
            padding: 3px 8px;
            border-radius: 30px;
            font-size: 0.7rem;
            font-weight: 600;
        }
    </style>
</head>
<body>
     <!--
        CopyLeft 2026 - UZTURRE
        Este c√≥digo es completamente libre.
        Puedes copiarlo, modificarlo y compartirlo sin pedir permiso.
        Si te sirve, √∫salo; si lo mejoras, comp√°rtelo.
        Esto es CopyLeft: el conocimiento no se posee, se comparte.
    -->

    <!-- Men√∫ de navegaci√≥n -->
    <nav class="nav-master">
        <a href="index.html" class="nav-btn active"><i class="fas fa-home"></i> INICIO</a>
        <a href="victron.html" class="nav-btn"><i class="fas fa-solar-panel"></i> VICTRON</a>
        <a href="bateria.html" class="nav-btn"><i class="fas fa-battery-full"></i> BATER√çA</a>
        <a href="logs.html" class="nav-btn"><i class="fas fa-history"></i> LOGS</a>
    </nav>

    <div class="dashboard">
        
        <!-- Cabecera con t√≠tulo y estado MQTT -->
        <header class="header">
            <div>
                <h1>SIENA 395 <span style="font-weight: 300; font-size: 1rem;">S3</span></h1>
                <div style="font-size: 0.75rem; color: #888; font-weight: 600;">
                    <i class="far fa-calendar-alt"></i> MONITORIZACI√ìN MIKEL 2026
                </div>
            </div>
            <div id="mqtt-status" class="badge" style="background: #ffebee; color: #e74c3c; border: 1px solid #ffcdd2;">
                <i class="fas fa-circle"></i> DESCONECTADO
            </div>
        </header>

        <!-- Tarjeta de Flujo de Energ√≠a -->
        <div class="card">
            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 20px; color: var(--accent-primary); font-weight: 700;">
                <i class="fas fa-bolt"></i> FLUJO DE ENERG√çA (ACTUAL)
            </div>
            
            <div class="flow-grid">
                <!-- Fila: Producci√≥n Solar -->
                <div class="flow-row">
                    <span class="flow-label"><i class="fas fa-sun"></i> Producci√≥n solar</span>
                    <span class="flow-value value-orange" id="flowSolar">-- W</span>
                </div>
                
                <!-- Fila: Bater√≠a (Carga/Descarga) -->
                <div class="flow-row">
                    <span class="flow-label"><i class="fas fa-battery-half"></i> Bater√≠a</span>
                    <span class="flow-value" id="flowBattery">-- W</span>
                </div>
                
                <!-- Fila: Consumo Red (si lo tienes) -->
                <div class="flow-row">
                    <span class="flow-label"><i class="fas fa-city"></i> Consumo red</span>
                    <span class="flow-value value-blue" id="flowGrid">-- W</span>
                </div>
                
                <!-- Fila: Consumo Total -->
                <div class="flow-row" style="border-bottom: none; margin-top: 5px;">
                    <span class="flow-label" style="font-weight: 800;"><i class="fas fa-home"></i> Consumo total</span>
                    <span class="flow-value" style="font-size: 1.5rem; color: var(--consumer-red);" id="flowLoad">-- W</span>
                </div>
            </div>
        </div>

        <!-- Mini tarjetas de resumen (SOC y Potencia Solar) -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label"><i class="fas fa-battery-three-quarters"></i> BATER√çA</div>
                <div>
                    <span class="stat-value" id="mainSoc" style="color: var(--victron-blue);">--</span>
                    <span class="stat-unit">%</span>
                </div>
                <div style="font-size: 0.8rem; color: #888; margin-top: 5px;" id="batteryPower">-- W</div>
            </div>
            <div class="stat-card">
                <div class="stat-label"><i class="fas fa-solar-panel"></i> SOLAR</div>
                <div>
                    <span class="stat-value" id="mainSolar" style="color: var(--solar-orange);">--</span>
                    <span class="stat-unit">W</span>
                </div>
                <div style="font-size: 0.8rem; color: #888; margin-top: 5px;" id="solarToday">Hoy: -- kWh</div>
            </div>
        </div>

        <!-- Botones de acceso r√°pido a otras vistas -->
        <div style="display: flex; flex-direction: column; gap: 10px; margin-top: 10px;">
            <button class="nav-btn button-large" onclick="window.location.href='victron.html'">
                <span><i class="fas fa-chart-line"></i> Ver equipos Victron</span> 
                <i class="fas fa-chevron-right"></i>
            </button>
            <button class="nav-btn button-large" onclick="window.location.href='bateria.html'">
                <span><i class="fas fa-microchip"></i> Ver Celdas Ultimatron</span> 
                <i class="fas fa-chevron-right"></i>
            </button>
        </div>

                <!-- √öltima actualizaci√≥n -->
        <div style="text-align: center; font-size: 0.7rem; color: #888; margin-top: 20px; padding: 10px;">
            <i class="far fa-clock"></i> √öltima actualizaci√≥n: <span id="lastUpdate">--:--:--</span>
        </div>

        <!-- CopyLeft visible -->
        <div style="text-align: center; font-size: 0.6rem; color: #aaa; margin-top: 5px; padding: 8px; border-top: 1px dashed var(--border-light);">
            üè¥‚Äç‚ò†Ô∏è CopyLeft 2026 - UZTURRE ¬∑ El conocimiento no se posee, se comparte ¬∑ C√≥digo 100% libre
        </div>
    </div>

    <!-- Bot√≥n flotante para modo oscuro/claro -->
    <div class="theme-switch" id="themeToggle">
        <i class="fas fa-moon"></i>
    </div>

    <script>
        // --- CONFIGURACI√ìN MQTT (IGUAL QUE EN BATERIA Y VICTRON) ---
        const BROKER = 'wss://broker.emqx.io:8084/mqtt';
        
        // Estado de conexi√≥n
        const mqttStatusEl = document.getElementById('mqtt-status');
        const lastUpdateEl = document.getElementById('lastUpdate');
        
        // Elementos a actualizar
        const elements = {
            mainSoc: document.getElementById('mainSoc'),
            mainSolar: document.getElementById('mainSolar'),
            flowSolar: document.getElementById('flowSolar'),
            flowBattery: document.getElementById('flowBattery'),
            flowGrid: document.getElementById('flowGrid'),
            flowLoad: document.getElementById('flowLoad'),
            batteryPower: document.getElementById('batteryPower'),
            solarToday: document.getElementById('solarToday')
        };

        // Almacenar valores para c√°lculos
        let values = {
            solarPower: 0,
            batteryPower: 0,
            gridPower: 0,
            loadPower: 0,
            soc: 0,
            solarTodayKWh: 0
        };

        // Conectar al broker MQTT
        const client = mqtt.connect(BROKER);

        client.on('connect', () => {
            console.log('‚úÖ Conectado al broker MQTT');
            mqttStatusEl.innerHTML = '<i class="fas fa-circle"></i> CONECTADO';
            mqttStatusEl.style.background = '#e8f5e9';
            mqttStatusEl.style.color = '#27ae60';
            mqttStatusEl.style.borderColor = '#c8e6c9';
            
            // Suscribirse a TODOS los sensores (como en bateria.html y victron.html)
            client.subscribe('mi_clave_privada_siena/sensor/#');
            console.log('üì° Suscrito a: mi_clave_privada_siena/sensor/#');
        });

        client.on('error', (err) => {
            console.error('‚ùå Error MQTT:', err);
            mqttStatusEl.innerHTML = '<i class="fas fa-exclamation-triangle"></i> ERROR';
            mqttStatusEl.style.background = '#ffebee';
            mqttStatusEl.style.color = '#e74c3c';
        });

        client.on('message', (topic, message) => {
            const payload = message.toString();
            const timestamp = new Date().toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            lastUpdateEl.innerText = timestamp;
            
            console.log(`üì® ${topic} = ${payload}`);
            
            // Extraer el nombre del sensor (parte despu√©s de /sensor/)
            const parts = topic.split('/');
            if (parts.length >= 4) {
                const sensorName = parts[2]; // "siena_bms_voltaje", "siena_mppt_potencia_solar", etc.
                
                switch(sensorName) {
                    // SOC - Prioridad al shunt, luego al BMS
                    case 'siena_shunt_soc':
                        values.soc = parseFloat(payload);
                        elements.mainSoc.innerText = values.soc.toFixed(1);
                        break;
                    case 'siena_bms_soc':
                        if (!values.soc) {
                            values.soc = parseFloat(payload);
                            elements.mainSoc.innerText = values.soc.toFixed(1);
                        }
                        break;
                    
                    // Potencia solar
                    case 'siena_mppt_potencia_solar':
                        values.solarPower = parseFloat(payload) || 0;
                        elements.mainSolar.innerText = values.solarPower.toFixed(0);
                        elements.flowSolar.innerText = values.solarPower.toFixed(0) + ' W';
                        break;
                    
                    // Energ√≠a solar hoy
                    case 'siena_mppt_hoy':
                        values.solarTodayKWh = parseFloat(payload) || 0;
                        elements.solarToday.innerText = `Hoy: ${values.solarTodayKWh.toFixed(2)} kWh`;
                        break;
                    
                    // Potencia de bater√≠a (carga/descarga)
                    case 'siena_bms_potencia':
                        values.batteryPower = parseFloat(payload) || 0;
                        const batteryText = values.batteryPower > 0 ? '‚ö° Cargando' : (values.batteryPower < 0 ? 'üîã Descargando' : '‚è∏Ô∏è Reposo');
                        elements.flowBattery.innerText = values.batteryPower.toFixed(0) + ' W';
                        elements.batteryPower.innerText = batteryText + ` (${values.batteryPower.toFixed(0)} W)`;
                        break;
                    
                    // Consumo total (puede venir de varios lados)
                    case 'siena_inversor_potencia':
                        if (payload !== 'nan') {
                            values.loadPower = parseFloat(payload) || 0;
                            elements.flowLoad.innerText = values.loadPower.toFixed(0) + ' W';
                        }
                        break;
                    
                    // Orion DC-DC (alternador)
                    case 'siena_orion_corriente':
                        // Puedes usar esto para calcular consumo del alternador si lo necesitas
                        break;
                }
            }
            
            // Tambi√©n mantener compatibilidad con t√≥picos antiguos si es necesario
            if (topic.includes('bateria_porcentaje')) {
                values.soc = parseFloat(payload) || 0;
                elements.mainSoc.innerText = values.soc.toFixed(1);
            }
            if (topic.includes('potencia_solar_actual')) {
                values.solarPower = parseFloat(payload) || 0;
                elements.mainSolar.innerText = values.solarPower.toFixed(0);
                elements.flowSolar.innerText = values.solarPower.toFixed(0) + ' W';
            }
        });

        // --- MODO OSCURO / CLARO ---
        const themeToggle = document.getElementById('themeToggle');
        const themeIcon = themeToggle.querySelector('i');
        
        // Comprobar preferencia guardada
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme === 'dark') {
            document.body.classList.add('dark-mode');
            themeIcon.classList.remove('fa-moon');
            themeIcon.classList.add('fa-sun');
        }
        
        themeToggle.addEventListener('click', () => {
            document.body.classList.toggle('dark-mode');
            
            if (document.body.classList.contains('dark-mode')) {
                themeIcon.classList.remove('fa-moon');
                themeIcon.classList.add('fa-sun');
                localStorage.setItem('theme', 'dark');
            } else {
                themeIcon.classList.remove('fa-sun');
                themeIcon.classList.add('fa-moon');
                localStorage.setItem('theme', 'light');
            }
        });

        console.log('üöÄ Dashboard Siena 395 iniciado');
        console.log('üì° Esperando datos de: mi_clave_privada_siena/sensor/#');
    </script>
</body>
</html>
