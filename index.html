<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Siena395 PRO Monitor</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <style>
        :root {
            /* TEMA CLARO PRO - Contraste alto para exteriores */
            --bg: #a0aec0;
            --card: #cbd5e0;
            --header: linear-gradient(135deg, #1a365d, #2b6cb0);
            --text: #1a202c;
            --accent: #3182ce;
            --success: #38a169;
            --warning: #d69e2e;
            --danger: #e53e3e;
            --border: #718096;
        }

        .dark-mode {
            --bg: #1a202c;
            --card: #2d3748;
            --text: #f7fafc;
            --border: #4a5568;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { background-color: var(--bg); color: var(--text); padding: 12px; transition: 0.3s; }

        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(340px, 1fr));
            gap: 15px;
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            grid-column: 1 / -1;
            background: var(--header);
            color: white;
            padding: 20px;
            border-radius: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .card {
            background: var(--card);
            border-radius: 16px;
            padding: 20px;
            border: 1px solid var(--border);
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
        }

        /* BATER√çA PRINCIPAL */
        .hero-card { grid-column: 1 / -1; text-align: center; }
        .soc-text { font-size: 4.5rem; font-weight: 800; line-height: 1; margin: 10px 0; color: var(--accent); }
        
        /* DIAGRAMA DE FLUJO */
        .flow-container {
            position: relative;
            height: 300px;
            background: rgba(0,0,0,0.03);
            border-radius: 12px;
            margin: 15px 0;
            overflow: hidden;
        }
        canvas#flowCanvas { width: 100%; height: 100%; }

        /* GRID DE EQUIPOS */
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-top: 10px;
        }
        .stat-box {
            background: rgba(255,255,255,0.2);
            padding: 12px;
            border-radius: 10px;
            text-align: center;
            border: 1px solid var(--border);
        }
        .stat-label { font-size: 0.75rem; text-transform: uppercase; font-weight: 600; opacity: 0.8; }
        .stat-value { font-size: 1.2rem; font-weight: 800; }

        /* HIST√ìRICO */
        .history-card { grid-column: 1 / -1; }

        .btn {
            background: var(--accent);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 50px;
            font-weight: 600;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="dashboard">
        <header>
            <div>
                <h1 style="font-size: 1.4rem;">Siena395 PRO</h1>
                <span id="mqttStatus" style="font-size: 0.8rem; opacity: 0.8;">üîå Desconectado</span>
            </div>
            <button class="btn" onclick="document.body.classList.toggle('dark-mode')">
                <i class="fas fa-adjust"></i>
            </button>
        </header>

        <section class="card hero-card">
            <div class="stat-label">Estado de Carga - Ultimatron 100Ah</div>
            <div id="socValue" class="soc-text">--%</div>
            <div class="stats-grid">
                <div class="stat-box"><div class="stat-label">Voltaje</div><div id="vBat" class="stat-value">--V</div></div>
                <div class="stat-box"><div class="stat-label">Corriente</div><div id="iBat" class="stat-value">--A</div></div>
            </div>
        </section>

        <section class="card history-card">
            <div class="stat-label"><i class="fas fa-sync-alt fa-spin"></i> Flujo en Tiempo Real</div>
            <div class="flow-container">
                <canvas id="flowCanvas"></canvas>
            </div>
        </section>

        <section class="card">
            <div class="stat-label"><i class="fas fa-sun"></i> MPPT SmartSolar</div>
            <div class="stats-grid">
                <div class="stat-box"><div class="stat-label">Potencia</div><div id="solW" class="stat-value">--W</div></div>
                <div class="stat-box"><div class="stat-label">Hoy</div><div id="solYield" class="stat-value">--kWh</div></div>
            </div>
        </section>

        <section class="card">
            <div class="stat-label"><i class="fas fa-bolt"></i> Phoenix Inverter</div>
            <div class="stats-grid">
                <div class="stat-box"><div class="stat-label">Carga</div><div id="invW" class="stat-value">--VA</div></div>
                <div class="stat-box"><div class="stat-label">Estado</div><div id="invState" class="stat-value">--</div></div>
            </div>
        </section>

        <section class="card">
            <div class="stat-label"><i class="fas fa-truck"></i> Orion DC-DC</div>
            <div class="stats-grid">
                <div class="stat-box"><div class="stat-label">Entrada</div><div id="oriIn" class="stat-value">--V</div></div>
                <div class="stat-box"><div class="stat-label">Salida</div><div id="oriOut" class="stat-value">--V</div></div>
            </div>
        </section>

        <section class="card history-card">
            <canvas id="mainChart" height="150"></canvas>
        </section>
    </div>

    <script>
        // CONFIGURACI√ìN MQTT REAL
        const BROKER = 'wss://broker.emqx.io:8084/mqtt';
        const client = mqtt.connect(BROKER);

        client.on('connect', () => {
            document.getElementById('mqttStatus').innerText = 'üü¢ En L√≠nea';
            client.subscribe('siena395/sensor/#');
        });

        // ANIMACI√ìN DE PART√çCULAS PRO (RADIO 2.2)
        const canvas = document.getElementById('flowCanvas');
        const ctx = canvas.getContext('2d');
        let particles = [];

        class Particle {
            constructor(x, y, targetX, targetY, color) {
                this.x = x; this.y = y;
                this.startX = x; this.startY = y;
                this.targetX = targetX; this.targetY = targetY;
                this.progress = Math.random();
                this.color = color;
            }
            draw() {
                const curX = this.startX + (this.targetX - this.startX) * this.progress;
                const curY = this.startY + (this.targetY - this.startY) * this.progress;
                ctx.beginPath();
                ctx.arc(curX, curY, 2.2, 0, Math.PI * 2);
                ctx.fillStyle = this.color;
                ctx.shadowBlur = 8; ctx.shadowColor = this.color;
                ctx.fill();
                this.progress += 0.005;
                if (this.progress >= 1) this.progress = 0;
            }
        }

        function initParticles() {
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;
            particles = [
                new Particle(50, 50, canvas.width/2, canvas.height/2, '#d69e2e'), // Solar
                new Particle(canvas.width-50, canvas.height/2, canvas.width/2, canvas.height/2, '#e53e3e') // Consumo
            ];
        }

        function animate() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            // Dibujar l√≠neas de fondo
            ctx.strokeStyle = 'rgba(255,255,255,0.1)'; ctx.lineWidth = 1;
            ctx.strokeRect(40, 40, canvas.width-80, canvas.height-80);
            
            particles.forEach(p => p.draw());
            requestAnimationFrame(animate);
        }

        // GR√ÅFICO DE HIST√ìRICO
        const chartCtx = document.getElementById('mainChart').getContext('2d');
        const mainChart = new Chart(chartCtx, {
            type: 'line',
            data: {
                labels: Array(24).fill(''),
                datasets: [{
                    label: 'SOC %',
                    data: [],
                    borderColor: '#3182ce',
                    tension: 0.4,
                    fill: true,
                    backgroundColor: 'rgba(49, 130, 206, 0.1)'
                }]
            },
            options: { responsive: true, plugins: { legend: { display: false } } }
        });

        window.onload = () => {
            initParticles();
            animate();
        };
    </script>
</body>
</html>
