<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Dashboard Siena395 Monitor</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <style>
        :root {
            /* Modo claro (default) */
            --primary: #2d3748;
            --secondary: #4a5568;
            --accent: #3182ce;
            --danger: #e53e3e;
            --warning: #d69e2e;
            --success: #38a169;
            --info: #4299e1;
            --light: #f0f4f8;
            --dark: #1a202c;
            --bg-color: #edf2f7;
            --card-bg: #e8edf2;
            --text-color: #2d3748;
            --border-color: #e2e8f0;
            --border-radius: 14px;
            --shadow: 0 6px 16px rgba(0, 0, 0, 0.08);
            --shadow-hover: 0 10px 28px rgba(0, 0, 0, 0.12);
            --card-gradient: linear-gradient(145deg, #f1f5f9, #e8edf2);
        }

        .dark-mode {
            /* Modo oscuro */
            --primary: #ffffff;
            --secondary: #e2e8f0;
            --accent: #63b3ed;
            --danger: #fc8181;
            --warning: #f6ad55;
            --success: #68d391;
            --info: #76c9f9;
            --light: #2d3748;
            --dark: #f7fafc;
            --bg-color: #1a202c;
            --card-bg: #2d3748;
            --text-color: #ffffff;
            --border-color: #4a5568;
            --shadow: 0 6px 16px rgba(0, 0, 0, 0.3);
            --shadow-hover: 0 10px 28px rgba(0, 0, 0, 0.4);
            --card-gradient: linear-gradient(145deg, #374151, #2d3748);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
            padding: 12px;
            transition: background-color 0.3s, color 0.3s;
        }

        .container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 16px;
            max-width: 1200px;
            margin: 0 auto;
        }

        /* Header */
        header {
            grid-column: 1 / -1;
            background: linear-gradient(135deg, var(--accent), var(--info));
            color: white;
            padding: 18px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            margin-bottom: 12px;
            display: flex;
            flex-direction: column;
            gap: 14px;
        }

        .header-top { display: flex; justify-content: space-between; align-items: center; }

        .status-dot { width: 10px; height: 10px; border-radius: 50%; background-color: var(--success); animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.1); opacity: 0.7; } }

        /* Cards */
        .card {
            background: var(--card-gradient);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 20px;
            border: 1px solid var(--border-color);
            position: relative;
            overflow: hidden;
        }

        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid var(--border-color); padding-bottom: 10px; }
        .card-title { font-weight: 700; display: flex; align-items: center; gap: 10px; }
        .card-icon { color: var(--accent); background: rgba(49, 130, 206, 0.1); padding: 8px; border-radius: 12px; width: 40px; height: 40px; display: flex; justify-content: center; align-items: center; }

        /* Battery Section */
        .battery-section { grid-column: 1 / -1; }
        .battery-container { display: flex; flex-direction: column; align-items: center; }
        .battery {
            width: 180px; height: 80px; border: 4px solid var(--primary); border-radius: 12px;
            position: relative; margin-bottom: 16px;
        }
        .battery::after { content: ''; position: absolute; top: 50%; right: -12px; transform: translateY(-50%); width: 8px; height: 24px; background: var(--primary); border-radius: 0 4px 4px 0; }
        .battery-level { height: 100%; background: linear-gradient(90deg, var(--success), var(--warning), var(--danger)); transition: width 0.5s; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; }

        /* SOC CENTRADO */
        .soc-display { width: 100%; text-align: center; margin: 15px 0; }
        .soc-value { font-size: 3.5rem; font-weight: 800; color: var(--primary); display: block; }
        .soc-label { font-size: 1rem; color: var(--secondary); font-weight: 500; }

        .battery-info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; width: 100%; max-width: 500px; }
        .info-item { background: var(--light); padding: 15px; border-radius: 10px; text-align: center; border: 1px solid var(--border-color); }
        .info-label { font-size: 0.75rem; text-transform: uppercase; color: var(--secondary); margin-bottom: 5px; }
        .info-value { font-size: 1.2rem; font-weight: 700; }

        /* Diagrama de Flujo - MEJORADO */
        .flow-section { grid-column: 1 / -1; }
        .flow-diagram { 
            position: relative; height: 450px; /* Más espacio vertical */
            background: var(--light); border-radius: 16px; overflow: hidden; border: 2px solid var(--border-color);
        }

        .flow-node {
            position: absolute; width: 85px; height: 85px; border-radius: 50%;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: white; font-weight: 700; font-size: 0.75rem; z-index: 2;
            box-shadow: var(--shadow); border: 3px solid rgba(255,255,255,0.4);
        }

        /* LÍNEAS Y PARTÍCULAS MEJORADAS */
        .flow-line {
            position: absolute; height: 6px; /* Más gruesa */
            background: rgba(49, 130, 206, 0.2); transform-origin: 0 0; z-index: 1;
        }

        .flow-particle {
            position: absolute; width: 12px; height: 12px; /* Más grande */
            background: var(--accent); border-radius: 50%; z-index: 2;
            box-shadow: 0 0 10px var(--accent);
        }

        .flow-line.active { background: rgba(56, 161, 105, 0.3); }
        .flow-particle.active { background: var(--success); box-shadow: 0 0 12px var(--success); }

        /* Botones */
        .action-button { 
            background: var(--accent); color: white; border: none; padding: 8px 16px; 
            border-radius: 20px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 8px;
        }

        /* Logs y Alertas */
        .logs-section { grid-column: 1 / -1; }
        .logs-container { height: 200px; overflow-y: auto; background: var(--card-bg); border-radius: 8px; padding: 10px; font-family: monospace; font-size: 0.85rem; }
        
        .alarms-container { display: flex; gap: 15px; overflow-x: auto; padding-bottom: 10px; }
        .alarm { min-width: 280px; padding: 15px; border-radius: 10px; border-left: 5px solid var(--info); background: var(--light); }

        @media (max-width: 600px) {
            .soc-value { font-size: 2.5rem; }
            .flow-diagram { height: 400px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-top">
                <div class="header-left">
                    <h1><i class="fas fa-caravan"></i> Siena395 Monitor</h1>
                    <p>ESP32: <span id="connectionText">Conectando...</span></p>
                </div>
                <div class="header-right">
                    <button id="themeToggle" class="action-button" style="background: rgba(255,255,255,0.2)"><i class="fas fa-moon"></i></button>
                </div>
            </div>
        </header>

        <section class="card battery-section">
            <div class="card-header">
                <h2 class="card-title"><i class="fas fa-battery-full card-icon"></i> Ultimatron 100Ah</h2>
                <button class="action-button" id="manualRefresh"><i class="fas fa-sync"></i> Actualizar</button>
            </div>
            <div class="battery-container">
                <div class="battery">
                    <div id="batteryLevel" class="battery-level" style="width: 0%">0%</div>
                </div>
                <div class="soc-display">
                    <span id="socValue" class="soc-value">--%</span>
                    <span class="soc-label">Estado de Carga (SOC)</span>
                </div>
                <div class="battery-info-grid">
                    <div class="info-item"><div class="info-label">Voltaje</div><div class="info-value"><span id="voltageValue">--</span>V</div></div>
                    <div class="info-item"><div class="info-label">Corriente</div><div class="info-value"><span id="currentValue">--</span>A</div></div>
                </div>
            </div>
        </section>

        <section class="card flow-section">
            <div class="card-header">
                <h2 class="card-title"><i class="fas fa-project-diagram card-icon"></i> Flujo de Energía</h2>
                <button class="action-button" id="toggleFlow"><i class="fas fa-play"></i> Animación</button>
            </div>
            <div id="flowDiagram" class="flow-diagram">
                </div>
        </section>

        <section class="card logs-section">
            <div class="card-header">
                <h2 class="card-title"><i class="fas fa-terminal card-icon"></i> Logs</h2>
            </div>
            <div id="logsContainer" class="logs-container"></div>
        </section>
    </div>

    <script>
        // Configuración de Nodos con más separación vertical
        const nodes = [
            { id: 'solar', name: 'Solar', icon: 'fa-sun', x: 50, y: 15, color: '#d69e2e' },
            { id: 'alternator', name: 'Motor', icon: 'fa-truck', x: 20, y: 45, color: '#718096' },
            { id: 'battery', name: 'Batería', icon: 'fa-car-battery', x: 50, y: 45, color: '#38a169' },
            { id: 'inverter', name: '220V', icon: 'fa-bolt', x: 80, y: 45, color: '#3182ce' },
            { id: 'loads', name: 'Consumos', icon: 'fa-lightbulb', x: 50, y: 80, color: '#e53e3e' }
        ];

        const connections = [
            { from: 'solar', to: 'battery' },
            { from: 'alternator', to: 'battery' },
            { from: 'battery', to: 'inverter' },
            { from: 'battery', to: 'loads' }
        ];

        function initFlow() {
            const container = document.getElementById('flowDiagram');
            container.innerHTML = '';
            
            // Dibujar Líneas (Grosor 6px)
            connections.forEach(conn => {
                const f = nodes.find(n => n.id === conn.from);
                const t = nodes.find(n => n.id === conn.to);
                const line = document.createElement('div');
                line.className = 'flow-line';
                
                const dx = (t.x - f.x) * container.clientWidth / 100;
                const dy = (t.y - f.y) * container.clientHeight / 100;
                const dist = Math.sqrt(dx*dx + dy*dy);
                const angle = Math.atan2(dy, dx) * 180 / Math.PI;

                line.style.width = dist + 'px';
                line.style.left = (f.x * container.clientWidth / 100) + 'px';
                line.style.top = (f.y * container.clientHeight / 100) + 'px';
                line.style.transform = `rotate(${angle}deg)`;
                container.appendChild(line);

                // Partícula (12px)
                const part = document.createElement('div');
                part.className = 'flow-particle active';
                part.style.offsetPath = `path('M 0 0 L ${dx} ${dy}')`;
                part.style.left = (f.x * container.clientWidth / 100) + 'px';
                part.style.top = (f.y * container.clientHeight / 100) + 'px';
                part.style.animation = `flowMove 3s linear infinite`;
                container.appendChild(part);
            });

            // Dibujar Nodos
            nodes.forEach(node => {
                const div = document.createElement('div');
                div.className = 'flow-node';
                div.style.left = `calc(${node.x}% - 42px)`;
                div.style.top = `calc(${node.y}% - 42px)`;
                div.style.backgroundColor = node.color;
                div.innerHTML = `<i class="fas ${node.icon} fa-2x"></i><span>${node.name}</span>`;
                container.appendChild(div);
            });
        }

        // Animación de partículas
        const style = document.createElement('style');
        style.innerHTML = `@keyframes flowMove { from { offset-distance: 0%; } to { offset-distance: 100%; } }`;
        document.head.appendChild(style);

        // Tema y Eventos
        document.getElementById('themeToggle').addEventListener('click', () => {
            document.body.classList.toggle('dark-mode');
        });

        window.addEventListener('resize', initFlow);
        document.addEventListener('DOMContentLoaded', initFlow);

        // Simulación de datos
        function updateData() {
            const soc = Math.floor(Math.random() * 100);
            document.getElementById('socValue').innerText = soc + '%';
            document.getElementById('batteryLevel').style.width = soc + '%';
            document.getElementById('batteryLevel').innerText = soc + '%';
            document.getElementById('voltageValue').innerText = (12.8 + Math.random()).toFixed(2);
            document.getElementById('currentValue').innerText = (Math.random() * 10).toFixed(1);
        }
        setInterval(updateData, 3000);
    </script>
</body>
</html>
