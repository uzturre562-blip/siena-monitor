<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Siena395 Ultra Monitor</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;900&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <style>
        :root {
            --bg: #a0aec0; /* Gris oscuro para el fondo */
            --card: #cbd5e0; /* Tarjetas oscurecidas para contraste */
            --header: #1a202c;
            --accent: #3182ce;
            --solar: #d69e2e;
            --battery: #38a169;
            --load: #e53e3e;
            --text: #1a202c;
            --radius: 18px;
        }

        .dark-mode {
            --bg: #0f172a;
            --card: #1e293b;
            --text: #f8fafc;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { background-color: var(--bg); color: var(--text); padding: 15px; transition: 0.3s; }

        .container { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px; max-width: 1400px; margin: 0 auto; }

        header {
            grid-column: 1 / -1; background: var(--header); color: white;
            padding: 20px; border-radius: var(--radius); display: flex;
            justify-content: space-between; align-items: center; box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }

        .card {
            background: var(--card); border-radius: var(--radius); padding: 20px;
            border: 1px solid rgba(0,0,0,0.1); display: flex; flex-direction: column;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }

        /* DIAGRAMA DE FLUJO PRO */
        .flow-section { grid-column: 1 / -1; position: relative; height: 380px; overflow: hidden; }
        #flowCanvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }
        
        .node {
            position: absolute; z-index: 2; width: 70px; height: 70px;
            background: var(--card); border: 3px solid var(--bg);
            border-radius: 50%; display: flex; flex-direction: column;
            align-items: center; justify-content: center; box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        .node i { font-size: 1.4rem; color: var(--accent); }
        .node span { font-size: 0.6rem; font-weight: 800; margin-top: 4px; text-transform: uppercase; }

        /* Posicionamiento de Nodos */
        .n-solar { top: 10%; left: 10%; border-color: var(--solar); }
        .n-battery { top: 40%; left: 45%; border-color: var(--battery); width: 90px; height: 90px; }
        .n-inverter { top: 10%; left: 80%; border-color: var(--accent); }
        .n-orion { top: 70%; left: 10%; border-color: var(--solar); }
        .n-loads { top: 70%; left: 80%; border-color: var(--load); }

        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; }
        .stat-box { background: rgba(0,0,0,0.05); padding: 10px; border-radius: 12px; text-align: center; }
        .stat-val { font-size: 1.3rem; font-weight: 900; display: block; }
        .stat-lab { font-size: 0.7rem; opacity: 0.7; font-weight: 600; }

        .soc-main { font-size: 4rem; font-weight: 900; text-align: center; color: var(--battery); }
        
        /* Ocultar elementos de simulaci칩n */
        .hidden { display: none; }
    </style>
</head>
<body>

<div class="container">
    <header>
        <div>
            <h1 style="letter-spacing: -1px;">SIENA395 <span style="color: var(--accent);">ULTRA</span></h1>
            <div id="mqttStatus" style="font-size: 0.7rem; font-weight: 600;">游니 DESCONECTADO</div>
        </div>
        <button onclick="document.body.classList.toggle('dark-mode')" style="background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer;">
            <i class="fas fa-circle-half-stroke"></i>
        </button>
    </header>

    <section class="card flow-section">
        <canvas id="flowCanvas"></canvas>
        
        <div class="node n-solar"><i class="fas fa-sun"></i><span>Solar</span></div>
        <div class="node n-orion"><i class="fas fa-truck-moving"></i><span>Alternador</span></div>
        <div class="node n-battery">
            <i class="fas fa-car-battery" style="font-size: 2rem;"></i>
            <span id="socSmall">--%</span>
        </div>
        <div class="node n-inverter"><i class="fas fa-bolt"></i><span>AC 220V</span></div>
        <div class="node n-loads"><i class="fas fa-lightbulb"></i><span>DC Consumo</span></div>
    </section>

    <section class="card">
        <div class="stat-lab">BATER칈A ULTIMATRON 100Ah</div>
        <div id="socValue" class="soc-main">--%</div>
        <div class="stat-grid">
            <div class="stat-box"><span class="stat-lab">Tensi칩n</span><span id="vBat" class="stat-val">--V</span></div>
            <div class="stat-box"><span class="stat-lab">Corriente</span><span id="iBat" class="stat-val">--A</span></div>
        </div>
    </section>

    <section class="card" style="grid-column: 1 / -1;">
        <div class="stat-lab">HIST칍RICO DE CARGA (24H)</div>
        <canvas id="historyChart" height="120"></canvas>
    </section>

    <section class="card">
        <div class="stat-lab">MPPT SMART SOLAR</div>
        <div class="stat-grid">
            <div class="stat-box"><span class="stat-lab">Potencia</span><span id="solW" class="stat-val">--W</span></div>
            <div class="stat-box"><span class="stat-lab">Cosecha</span><span id="solK" class="stat-val">--kWh</span></div>
        </div>
    </section>

    <section class="card">
        <div class="stat-lab">PHOENIX INVERTER</div>
        <div class="stat-grid">
            <div class="stat-box"><span class="stat-lab">Carga AC</span><span id="invW" class="stat-val">--VA</span></div>
            <div class="stat-box"><span class="stat-lab">Estado</span><span id="invS" class="stat-val">--</span></div>
        </div>
    </section>
</div>

<script>
    // --- L칍GICA DE FLUJO PRO (Cables + Part칤culas 2.2px) ---
    const canvas = document.getElementById('flowCanvas');
    const ctx = canvas.getContext('2d');
    let width, height;

    const paths = [
        { from: 'solar', to: 'battery', color: '#d69e2e', active: false },
        { from: 'orion', to: 'battery', color: '#3182ce', active: false },
        { from: 'battery', to: 'inverter', color: '#3182ce', active: false },
        { from: 'battery', to: 'loads', color: '#e53e3e', active: false }
    ];

    function resize() {
        width = canvas.width = canvas.offsetWidth;
        height = canvas.height = canvas.offsetHeight;
    }

    function getPos(type) {
        if(type === 'solar') return { x: width * 0.1 + 35, y: height * 0.1 + 35 };
        if(type === 'orion') return { x: width * 0.1 + 35, y: height * 0.7 + 35 };
        if(type === 'battery') return { x: width * 0.45 + 45, y: height * 0.4 + 45 };
        if(type === 'inverter') return { x: width * 0.8 + 35, y: height * 0.1 + 35 };
        if(type === 'loads') return { x: width * 0.8 + 35, y: height * 0.7 + 35 };
    }

    function draw() {
        ctx.clearRect(0, 0, width, height);
        const time = Date.now() * 0.002;

        paths.forEach(path => {
            const start = getPos(path.from);
            const end = getPos(path.to);

            // Dibujar el cable (ra칤l)
            ctx.beginPath();
            ctx.moveTo(start.x, start.y);
            ctx.lineTo(end.x, end.y);
            ctx.strokeStyle = 'rgba(0,0,0,0.1)';
            ctx.lineWidth = 4;
            ctx.stroke();

            // Part칤culas (solo si hay flujo real - simulado aqu칤 para que lo veas)
            // En producci칩n, cambia 'true' por tu condici칩n de potencia > 0
            if (true) { 
                for (let i = 0; i < 3; i++) {
                    const offset = (time + i * 0.5) % 1;
                    const px = start.x + (end.x - start.x) * offset;
                    const py = start.y + (end.y - start.y) * offset;

                    ctx.beginPath();
                    ctx.arc(px, py, 2.2, 0, Math.PI * 2); // RADIO 2.2
                    ctx.fillStyle = path.color;
                    ctx.shadowBlur = 10;
                    ctx.shadowColor = path.color;
                    ctx.fill();
                }
            }
        });
        requestAnimationFrame(draw);
    }

    // --- MQTT & GR츼FICOS ---
    const client = mqtt.connect('wss://broker.emqx.io:8084/mqtt');
    client.on('connect', () => {
        document.getElementById('mqttStatus').innerText = '游릭 CONECTADO';
        client.subscribe('siena395/sensor/#');
    });

    client.on('message', (topic, msg) => {
        const val = msg.toString();
        if(topic.includes('soc')) {
            document.getElementById('socValue').innerText = val + '%';
            document.getElementById('socSmall').innerText = val + '%';
        }
        // Agrega aqu칤 el resto de tus mapeos de sensores
    });

    window.addEventListener('resize', resize);
    resize();
    draw();

    // Gr치fico de Hist칩rico con Chart.js
    const hChart = new Chart(document.getElementById('historyChart'), {
        type: 'line',
        data: {
            labels: Array(24).fill(''),
            datasets: [{
                label: 'SOC %',
                data: [85, 84, 83, 82, 85, 90, 95, 98, 100, 100, 98, 95],
                borderColor: '#3182ce',
                borderWidth: 3,
                tension: 0.4,
                pointRadius: 0,
                fill: true,
                backgroundColor: 'rgba(49, 130, 206, 0.1)'
            }]
        },
        options: { plugins: { legend: { display: false } }, scales: { y: { display: false }, x: { display: false } } }
    });
</script>

</body>
</html>
