<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MONITORIZACI√ìN AUTOCARAVANA     -PRO-     #v1.0.12#</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <style>
        /* ========== VARIABLES CSS ========== */
        :root {
            --bg: #a0aec0;
            --card: #cbd5e0;
            --text: #1a202c;
            --accent: #3182ce;
            --solar: #d69e2e;
            --battery: #38a169;
            --danger: #e53e3e;
            --border: #718096;
            --radius: 18px;
            --flow-line: #1a202c;
            --sense: #805ad5;
            --warning: #d69e2e;
        }
        .dark-mode { 
            --bg: #1a202c;
            --card: #2d3748;
            --text: #f7fafc;
            --border: #4a5568;
            --flow-line: #ffffff;
        }

        /* ========== RESET Y BASE ========== */
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
            font-family: 'Inter', sans-serif; 
            transition: 0.3s; 
        }
        
        body { 
            background-color: var(--bg); 
            color: var(--text); 
            padding: 15px; 
            display: flex; 
            justify-content: center; 
            min-height: 100vh;
        }
        
        .dashboard { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(340px, 1fr)); 
            gap: 15px; 
            max-width: 1200px; 
            width: 100%; 
        }

        /* ========== HEADER ========== */
        header { 
            grid-column: 1 / -1; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 5px 0 15px 0;
            border-bottom: 2px solid var(--border);
            margin-bottom: 10px;
        }
        
        header h1 { 
            font-size: 1.2rem; 
            font-weight: 900;
        }
        
        header h1 span { 
            color: var(--accent); 
        }
        
        .theme-btn {
            background: none;
            border: none;
            color: var(--text);
            font-size: 1.3rem;
            cursor: pointer;
            padding: 8px;
            border-radius: 10px;
            transition: background 0.2s;
        }
        
        .theme-btn:hover {
            background: rgba(0,0,0,0.05);
        }

        /* ========== TARJETAS ========== */
        .card { 
            background: var(--card); 
            border-radius: var(--radius); 
            padding: 18px; 
            border: 1px solid var(--border); 
            border-left: 6px solid var(--accent);
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); 
            position: relative;
            display: flex;
            flex-direction: column;
        }
        
        .card.c-mqtt { border-left-color: var(--accent); }
        .card.c-battery { border-left-color: var(--battery); }
        .card.c-solar { border-left-color: var(--solar); }
        .card.c-bms { border-left-color: var(--sense); } 
        .card.c-sense { border-left-color: var(--sense); }
        .card.c-logs { border-left-color: #2d3748; }
        
        .card-title { 
            font-size: 0.75rem; 
            font-weight: 900; 
            text-transform: uppercase; 
            margin-bottom: 10px; 
            display: flex; 
            align-items: center; 
            gap: 8px; 
            color: var(--text);
        }
        
        .card-title i { 
            font-size: 0.9rem; 
        }

        /* ========== BADGES ========== */
        .badge { 
            padding: 4px 12px; 
            border-radius: 20px; 
            font-size: 0.7rem; 
            font-weight: 900; 
            color: white; 
            text-transform: uppercase; 
        }
        
        .bg-on { background: var(--battery); }
        .bg-off { background: var(--danger); }
        .bg-wait { background: var(--warning); }

        /* ========== SECCI√ìN MQTT ========== */
        .mqtt-section {
            grid-column: 1 / -1;
            padding: 10px 18px !important;
        }
        
        .mqtt-status {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }
        
        .mqtt-topic {
            font-size: 0.65rem;
            color: var(--text);
            opacity: 0.8;
            margin-top: 5px;
            font-family: monospace;
        }

        /* ========== DIAGRAMA DE FLUJO ========== */
        .flow-section { 
            grid-column: 1 / -1; 
            height: 320px; 
            position: relative; 
            overflow: hidden; 
            background: var(--card); 
            border-left: none !important; 
            padding: 0 !important;
        }
        
        #flowCanvas { 
            width: 100%; 
            height: 100%; 
        }
        
        .node { 
            position: absolute; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center;
            font-size: 0.6rem; 
            font-weight: 800; 
            text-align: center; 
            width: 70px; 
            height: 70px; 
            z-index: 2; 
            border-radius: 50%; 
            background: var(--card); 
            border: 3px solid var(--border);
        }
        
        .node i { 
            font-size: 1.2rem; 
            margin-bottom: 2px; 
        }
        
        .n-solar { top: 10%; left: 15%; border-color: var(--solar); } 
        .n-orion { bottom: 10%; left: 15%; border-color: var(--accent); }
        .n-battery { top: 50%; left: 50%; transform: translate(-50%, -50%); border-color: var(--battery); width: 90px; height: 90px; font-size: 0.8rem; }
        .n-inverter { top: 10%; right: 15%; border-color: var(--accent); } 
        .n-loads { bottom: 10%; right: 15%; border-color: var(--danger); }

        /* ========== BATER√çA PRINCIPAL ========== */
        .soc-big { 
            font-size: 3.5rem; 
            font-weight: 900; 
            text-align: center; 
            margin: 5px 0; 
            color: var(--battery); 
            letter-spacing: -2px; 
        }
        
        .stats-grid-4 { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 10px; 
            margin-top: 10px;
        }
        
        .stat-item { 
            background: rgba(0,0,0,0.05); 
            padding: 10px; 
            border-radius: 12px; 
            text-align: center; 
        }
        
        .val { 
            display: block; 
            font-size: 1.1rem; 
            font-weight: 900; 
        }
        
        .lab { 
            font-size: 0.6rem; 
            font-weight: 700; 
            text-transform: uppercase; 
            opacity: 0.7; 
        }

        /* ========== CELDAS BMS ========== */
        .cell-container { 
            margin-top: 15px; 
            border-top: 1px solid var(--border); 
            padding-top: 10px; 
        }
        
        .cell-row { 
            display: flex; 
            align-items: center; 
            gap: 8px; 
            margin-bottom: 6px; 
        }
        
        .cell-label { 
            font-size: 0.65rem; 
            font-weight: 800; 
            width: 35px; 
        }
        
        .cell-bar-bg { 
            flex-grow: 1; 
            height: 12px; 
            background: rgba(0,0,0,0.1); 
            border-radius: 6px; 
            overflow: hidden; 
            border: 1px solid var(--border); 
        }
        
        .cell-bar-fill { 
            height: 100%; 
            width: 0%; 
            background: var(--battery); 
            transition: 1s ease-in-out; 
        }
        
        .cell-val { 
            font-size: 0.75rem; 
            font-weight: 900; 
            width: 55px; 
            text-align: right; 
            font-variant-numeric: tabular-nums; 
        }

        /* ========== GR√ÅFICO ========== */
        .chart-container { 
            position: relative; 
            height: 180px; 
            width: 100%; 
            grid-column: 1 / -1;
        }
        
        #histChart {
            width: 100% !important;
            height: 140px !important;
        }

        /* ========== LOGS ========== */
        .log-section {
            grid-column: 1 / -1;
        }
        
        .log-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .log-btn {
            background: var(--accent); 
            color: white; 
            border: none; 
            padding: 4px 10px; 
            border-radius: 6px; 
            font-size: 0.6rem; 
            font-weight: 800; 
            cursor: pointer;
        }
        
        .log-btn.paused {
            background: var(--danger);
        }
        
        #logContainer { 
            background: #1a202c; 
            color: #48bb78; 
            font-family: 'Courier New', monospace; 
            font-size: 0.65rem; 
            height: 120px; 
            overflow-y: auto; 
            padding: 10px; 
            border-radius: 8px; 
        }
        
        .dark-mode #logContainer {
            background: #0d1321;
        }

        /* ========== FOOTER ========== */
        footer { 
            grid-column: 1 / -1; 
            text-align: center; 
            font-size: 0.75rem; 
            opacity: 0.7; 
            padding: 20px 0; 
            font-weight: 600; 
            border-top: 1px solid var(--border);
            margin-top: 10px;
        }

        /* ========== RESPONSIVE ========== */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .dashboard {
                grid-template-columns: 1fr;
                gap: 12px;
            }
            
            header {
                flex-direction: column;
                gap: 10px;
                align-items: flex-start;
                padding-bottom: 10px;
            }
            
            header h1 {
                font-size: 1.1rem;
            }
            
            .flow-section {
                height: 250px;
            }
            
            .node {
                width: 60px;
                height: 60px;
                font-size: 0.55rem;
            }
            
            .n-battery {
                width: 80px;
                height: 80px;
            }
            
            .node i {
                font-size: 1rem;
            }
            
            .soc-big {
                font-size: 3rem;
            }
            
            .card {
                padding: 15px;
            }
            
            .n-solar { left: 8%; }
            .n-orion { left: 8%; }
            .n-inverter { right: 8%; }
            .n-loads { right: 8%; }
            
            .chart-container {
                height: 160px;
            }
            
            #histChart {
                height: 120px !important;
            }
        }

        @media (max-width: 480px) {
            .flow-section {
                height: 220px;
            }
            
            .node {
                width: 55px;
                height: 55px;
                font-size: 0.5rem;
            }
            
            .n-battery {
                width: 70px;
                height: 70px;
                font-size: 0.7rem;
            }
            
            .soc-big {
                font-size: 2.5rem;
            }
            
            .stats-grid-4 {
                grid-template-columns: 1fr;
                gap: 8px;
            }
            
            .card-title {
                font-size: 0.7rem;
            }
            
            .val {
                font-size: 1rem;
            }
        }

        /* ========== ANIMACIONES ========== */
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
        
        .critical {
            animation: pulse 1.5s infinite;
            color: var(--danger) !important;
        }
    </style>
</head>
<body>

<div class="dashboard">
    <!-- HEADER -->
    <header>
        <h1>MONITORIZACI√ìN AUTOCARAVANA<span>    -PRO-     #v1.0.12#</span></h1>
        <button class="theme-btn" onclick="toggleTheme()"><i class="fas fa-adjust"></i></button>
    </header>

    <!-- ESTADO MQTT -->
    <section class="card c-mqtt mqtt-section">
        <div class="mqtt-status">
            <div>
                <div class="card-title" style="margin-bottom: 0;"><i class="fas fa-network-wired"></i> ESTADO BROKER</div>
                <div class="mqtt-topic">siena395_monitor_mikel_2026/sensor/#</div>
            </div>
            <span id="mqttStatus" class="badge bg-wait">CONECTANDO...</span>
        </div>
    </section>

    <!-- DIAGRAMA DE FLUJO -->
    <section class="card flow-section">
        <canvas id="flowCanvas"></canvas>
        <div class="node n-solar"><i class="fas fa-sun" style="color:var(--solar)"></i><span>Solar</span></div>
        <div class="node n-orion"><i class="fas fa-truck-moving" style="color:var(--accent)"></i><span>Orion</span></div>
        <div class="node n-battery"><i class="fas fa-car-battery" style="color:var(--battery)"></i><span id="socMini">--%</span></div>
        <div class="node n-inverter"><i class="fas fa-plug" style="color:var(--accent)"></i><span>Phoenix</span></div>
        <div class="node n-loads"><i class="fas fa-lightbulb" style="color:var(--danger)"></i><span>Cargas</span></div>
    </section>

    <!-- SMARTSHUNT -->
    <section class="card c-battery">
        <div class="card-title"><i class="fas fa-car-battery" style="color:var(--battery)"></i> SMARTSHUNT 300A</div>
        <div id="socValue" class="soc-big">--%</div>
        <div class="stats-grid-4">
            <div class="stat-item"><span class="val" id="vBat">--V</span><span class="lab">Tensi√≥n</span></div>
            <div class="stat-item"><span class="val" id="iBat">--A</span><span class="lab">Corriente</span></div>
        </div>
    </section>

    <!-- BMS -->
    <section class="card c-bms">
        <div class="card-title"><i class="fas fa-bluetooth" style="color:var(--sense)"></i> BMS Ultimatron 100Ah</div>
        <div class="stats-grid-4">
            <div class="stat-item"><span class="val" id="bmsSoc">--%</span><span class="lab">SOC BMS</span></div>
            <div class="stat-item"><span class="val" id="bmsV">--V</span><span class="lab">Total</span></div>
            <div class="stat-item"><span class="val" id="bmsI">--A</span><span class="lab">BMS Amps</span></div>
            <div class="stat-item"><span class="val" id="bmsT">--¬∞C</span><span class="lab">BMS Temp</span></div>
        </div>
        <div class="cell-container">
            <div class="card-title" style="font-size: 0.6rem; margin-bottom: 8px; opacity: 0.8;">Voltaje de Celdas (LiFePO4)</div>
            <div id="cellList"></div>
        </div>
    </section>

    <!-- BATTERY SENSE -->
    <section class="card c-sense">
        <div class="card-title"><i class="fas fa-thermometer-half" style="color:var(--sense)"></i> BATTERY SENSE</div>
        <div class="stats-grid-4">
            <div class="stat-item"><span class="val" id="btsV">--V</span><span class="lab">Voltios Bater√≠a</span></div>
            <div class="stat-item"><span class="val" id="btsT">--¬∞C</span><span class="lab">Temperatura Bater√≠a</span></div>
        </div>
    </section>

    <!-- INVERSOR -->
    <section class="card" style="border-left-color: var(--accent);">
        <div class="card-title" style="justify-content: space-between;">
            <span><i class="fas fa-bolt"></i> Inversor 12V-2000VA</span>
            <span id="invStatus" class="badge bg-off">OFF</span>
        </div>
        <div class="stat-item" style="width:100%"><span class="val" id="invVA">--VA</span><span class="lab">Consumo AC</span></div>
    </section>

    <!-- SOLAR -->
    <section class="card c-solar">
        <div class="card-title"><i class="fas fa-sun"></i> SmartSolar 75/15</div>
        <div class="stats-grid-4">
            <div class="stat-item" style="grid-column: 1/-1;"><span class="val" id="solW">--W</span><span class="lab">Solar W</span></div>
            <div class="stat-item"><span class="val" id="solV">--V</span><span class="lab">Paneles</span></div>
            <div class="stat-item"><span class="val" id="solVbat">--V</span><span class="lab">V. Bat</span></div>
        </div>
    </section>

    <!-- ORION -->
    <section class="card">
        <div class="card-title"><i class="fas fa-shuttle-van"></i> Orion DC-DC 12V-30A</div>
        <div class="stats-grid-4">
            <div class="stat-item"><span class="val" id="oriIn">--V</span><span class="lab">Entrada</span></div>
            <div class="stat-item"><span class="val" id="oriOut">--V</span><span class="lab">Salida</span></div>
        </div>
    </section>

    <!-- GR√ÅFICO -->
    <section class="card chart-container">
        <div class="card-title"><i class="fas fa-chart-line"></i> Hist√≥rico SOC</div>
        <canvas id="histChart"></canvas>
    </section>

    <!-- LOGS -->
    <section class="card c-logs log-section">
        <div class="log-header">
            <div class="card-title" style="margin-bottom: 0;"><i class="fas fa-terminal"></i> Log Sistema</div>
            <button id="pauseBtn" class="log-btn" onclick="togglePause()">PAUSAR</button>
        </div>
        <div id="logContainer">Esperando datos...</div>
    </section>

    <!-- FOOTER -->
    <footer>- MONITORIZACI√ìN AUTOCARAVANA [SISTEMA VICTRON + BMS] - - üÑØ COPLEFT UZTURRE 2026 -</footer>
</div>

<script>
    // =============================================
    // CONFIGURACI√ìN Y VARIABLES GLOBALES
    // =============================================
    const CONFIG = {
        MQTT_BROKER: 'wss://broker.emqx.io:8084/mqtt',
        TOPIC_PREFIX: 'siena395_monitor_mikel_2026',
        CHART_MAX_POINTS: 50,
        LOG_MAX_ENTRIES: 8
    };

    let pSolar = 0;
    let pInv = 0;
    let iBat = 0;
    let isPaused = false;
    let mqttClient = null;
    let socChart = null;
    let flowAnimationId = null;

    // =============================================
    // INICIALIZACI√ìN DEL SISTEMA
    // =============================================
    document.addEventListener('DOMContentLoaded', function() {
        console.log('Inicializando sistema SIENA395...');
        
        // 1. Inicializar celdas BMS
        initializeCells();
        
        // 2. Inicializar gr√°fico
        initializeChart();
        
        // 3. Conectar MQTT
        connectMQTT();
        
        // 4. Inicializar animaci√≥n del flujo
        initializeFlowAnimation();
        
        // 5. Inicializar tema
        initializeTheme();
        
        addLog('Sistema inicializado. Esperando conexi√≥n MQTT...');
    });

    // =============================================
    // 1. INICIALIZAR CELDAS BMS
    // =============================================
    function initializeCells() {
        const cellList = document.getElementById('cellList');
        cellList.innerHTML = '';
        
        for(let i = 1; i <= 4; i++) {
            const cellRow = document.createElement('div');
            cellRow.className = 'cell-row';
            cellRow.innerHTML = `
                <div class="cell-label">C${i}</div>
                <div class="cell-bar-bg">
                    <div id="bar${i}" class="cell-bar-fill"></div>
                </div>
                <div id="vCell${i}" class="cell-val">-.---V</div>
            `;
            cellList.appendChild(cellRow);
        }
    }

    // =============================================
    // 2. INICIALIZAR GR√ÅFICO SOC
    // =============================================
    function initializeChart() {
        const ctx = document.getElementById('histChart').getContext('2d');
        
        socChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'SOC %',
                    data: [],
                    borderColor: '#38a169',
                    borderWidth: 2,
                    tension: 0.3,
                    fill: true,
                    backgroundColor: 'rgba(56, 161, 105, 0.1)',
                    pointRadius: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    y: {
                        min: 0,
                        max: 100,
                        ticks: {
                            color: function() {
                                return document.body.classList.contains('dark-mode') ? '#f7fafc' : '#1a202c';
                            }
                        }
                    },
                    x: { 
                        display: false,
                        grid: {
                            display: false
                        }
                    }
                },
                elements: {
                    line: {
                        tension: 0.3
                    }
                }
            }
        });
    }

    // =============================================
    // 3. CONEXI√ìN MQTT
    // =============================================
    function connectMQTT() {
        console.log('Conectando a MQTT:', CONFIG.MQTT_BROKER);
        
        mqttClient = mqtt.connect(CONFIG.MQTT_BROKER, {
            clientId: 'siena395_' + Math.random().toString(16).substr(2, 8),
            clean: true,
            reconnectPeriod: 5000
        });

        mqttClient.on('connect', function() {
            console.log('‚úÖ MQTT conectado');
            updateMQTTStatus('connected');
            mqttClient.subscribe(`${CONFIG.TOPIC_PREFIX}/sensor/#`);
            addLog('MQTT conectado. Suscrito a sensores.');
        });

        mqttClient.on('reconnect', function() {
            console.log('üîÑ Reconectando MQTT...');
            updateMQTTStatus('connecting');
            addLog('Reconectando MQTT...');
        });

        mqttClient.on('offline', function() {
            console.log('‚ùå MQTT desconectado');
            updateMQTTStatus('disconnected');
            addLog('MQTT desconectado');
        });

        mqttClient.on('error', function(error) {
            console.error('MQTT error:', error);
            addLog(`Error MQTT: ${error.message}`);
        });

        mqttClient.on('message', processMQTTMessage);
    }

    function updateMQTTStatus(status) {
        const badge = document.getElementById('mqttStatus');
        badge.className = 'badge';
        
        switch(status) {
            case 'connected':
                badge.classList.add('bg-on');
                badge.textContent = 'CONECTADO';
                break;
            case 'connecting':
                badge.classList.add('bg-wait');
                badge.textContent = 'CONECTANDO...';
                break;
            case 'disconnected':
                badge.classList.add('bg-off');
                badge.textContent = 'DESCONECTADO';
                break;
        }
    }

    // =============================================
    // 4. PROCESAR MENSAJES MQTT
    // =============================================
    function processMQTTMessage(topic, message) {
        const rawValue = message.toString();
        const value = parseFloat(rawValue);
        const sensor = topic.split('/')[2];

        if (!isPaused) {
            addLog(`${sensor}: ${rawValue}`);
        }

        // --- SOC BATER√çA ---
        if(sensor.includes('porcentaje_bateria') || sensor.includes('soc_bateria')) {
            updateSOC(value);
        }

        // --- VOLTAJE BATER√çA ---
        if(sensor.includes('voltaje_bateria')) {
            updateVoltage(value);
        }

        // --- CORRIENTE BATER√çA ---
        if(sensor.includes('corriente_bateria')) {
            updateCurrent(value);
        }

        // --- TEMPERATURA ---
        if(sensor.includes('temperatura')) {
            updateTemperature(value);
        }

        // --- CELDAS BMS ---
        if(sensor.includes('cell_voltage_')) {
            const match = sensor.match(/cell_voltage_(\d+)/);
            if(match) {
                const cellNum = parseInt(match[1]);
                if(cellNum <= 4) {
                    updateCellVoltage(cellNum, value);
                }
            }
        }

        // --- CORRIENTE BMS ---
        if(sensor.includes('bms_corriente') || sensor.includes('average_current')) {
            document.getElementById('bmsI').textContent = value.toFixed(1) + 'A';
        }

        // --- SOLAR ---
        if(sensor.includes('potencia_solar')) {
            document.getElementById('solW').textContent = Math.round(value) + 'W';
            pSolar = value;
        }
        if(sensor.includes('voltaje_paneles')) {
            document.getElementById('solV').textContent = value.toFixed(1) + 'V';
        }
        if(sensor.includes('voltaje_bateria_mppt')) {
            document.getElementById('solVbat').textContent = value.toFixed(1) + 'V';
        }

        // --- INVERSOR ---
        if(sensor.includes('potencia_salida_phoenix')) {
            document.getElementById('invVA').textContent = Math.round(value) + 'VA';
            pInv = value;
            
            // Actualizar estado del inversor
            const invStatus = document.getElementById('invStatus');
            if(value > 10) {
                invStatus.className = 'badge bg-on';
                invStatus.textContent = 'ON';
            } else {
                invStatus.className = 'badge bg-off';
                invStatus.textContent = 'OFF';
            }
        }

        // --- ORION ---
        if(sensor.includes('entrada_orion') || sensor.includes('voltaje_entrada_orion')) {
            document.getElementById('oriIn').textContent = value.toFixed(1) + 'V';
        }
        if(sensor.includes('salida_orion') || sensor.includes('voltaje_salida_orion')) {
            document.getElementById('oriOut').textContent = value.toFixed(2) + 'V';
        }
    }

    // =============================================
    // FUNCIONES DE ACTUALIZACI√ìN DE DATOS
    // =============================================
    function updateSOC(value) {
        const soc = Math.round(value);
        const socText = soc + '%';
        
        // Actualizar en m√∫ltiples lugares
        document.getElementById('socValue').textContent = socText;
        document.getElementById('socMini').textContent = socText;
        document.getElementById('bmsSoc').textContent = socText;
        
        // Actualizar gr√°fico
        updateChartData(value);
        
        // Alertas visuales
        const socElement = document.getElementById('socValue');
        if (soc < 15) {
            socElement.classList.add('critical');
        } else {
            socElement.classList.remove('critical');
        }
    }

    function updateVoltage(value) {
        const voltageText = value.toFixed(2) + 'V';
        
        document.getElementById('vBat').textContent = voltageText;
        document.getElementById('bmsV').textContent = voltageText;
        document.getElementById('btsV').textContent = voltageText;
        
        // Alertas de voltaje
        const voltageElement = document.getElementById('vBat');
        if (value < 12.0) {
            voltageElement.classList.add('critical');
        } else {
            voltageElement.classList.remove('critical');
        }
    }

    function updateCurrent(value) {
        const currentText = value.toFixed(1) + 'A';
        document.getElementById('iBat').textContent = currentText;
        iBat = value;
    }

    function updateTemperature(value) {
        const tempText = value.toFixed(1) + '¬∞C';
        document.getElementById('btsT').textContent = tempText;
        document.getElementById('bmsT').textContent = tempText;
    }

    function updateCellVoltage(cellNum, value) {
        const cellValue = value.toFixed(3) + 'V';
        document.getElementById(`vCell${cellNum}`).textContent = cellValue;
        
        // Calcular porcentaje para barra (LiFePO4: 2.8V - 3.6V)
        const percentage = ((value - 2.8) / (3.6 - 2.8)) * 100;
        const fillElement = document.getElementById(`bar${cellNum}`);
        fillElement.style.width = Math.min(Math.max(percentage, 0), 100) + '%';
        
        // Color seg√∫n voltaje
        if (value < 3.0) {
            fillElement.style.background = 'var(--danger)';
        } else {
            fillElement.style.background = 'var(--battery)';
        }
    }

    function updateChartData(value) {
        if (!socChart) return;
        
        socChart.data.labels.push('');
        socChart.data.datasets[0].data.push(value);
        
        if (socChart.data.labels.length > CONFIG.CHART_MAX_POINTS) {
            socChart.data.labels.shift();
            socChart.data.datasets[0].data.shift();
        }
        
        socChart.update();
    }

    // =============================================
    // 5. ANIMACI√ìN DEL DIAGRAMA DE FLUJO
    // =============================================
    function initializeFlowAnimation() {
        const canvas = document.getElementById('flowCanvas');
        const ctx = canvas.getContext('2d');
        
        function resizeCanvas() {
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;
        }
        
        function animate() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            const time = Date.now() * 0.002;
            
            const w = canvas.width;
            const h = canvas.height;
            
            // Posiciones de los nodos
            const pts = {
                solar: { x: w * 0.15 + 35, y: h * 0.1 + 35 },
                orion: { x: w * 0.15 + 35, y: h * 0.9 - 35 },
                battery: { x: w * 0.5, y: h * 0.5 },
                inverter: { x: w * 0.85 - 35, y: h * 0.1 + 35 },
                loads: { x: w * 0.85 - 35, y: h * 0.9 - 35 }
            };
            
            // Funci√≥n para dibujar l√≠neas animadas
            function drawAnimatedLine(from, to, active, color) {
                if (!active) return;
                
                ctx.beginPath();
                ctx.moveTo(from.x, from.y);
                ctx.lineTo(to.x, to.y);
                ctx.strokeStyle = color;
                ctx.lineWidth = 2;
                ctx.setLineDash([5, 10]);
                ctx.lineDashOffset = -time * 20;
                ctx.stroke();
            }
            
            // Dibujar flujos de energ√≠a
            drawAnimatedLine(pts.solar, pts.battery, pSolar > 5, 'var(--solar)');
            drawAnimatedLine(pts.battery, pts.inverter, pInv > 10, 'var(--accent)');
            drawAnimatedLine(pts.battery, pts.loads, iBat < -0.5, 'var(--danger)');
            
            flowAnimationId = requestAnimationFrame(animate);
        }
        
        // Inicializar y empezar animaci√≥n
        resizeCanvas();
        animate();
        
        // Redimensionar cuando cambie el tama√±o de ventana
        window.addEventListener('resize', function() {
            if (flowAnimationId) {
                cancelAnimationFrame(flowAnimationId);
            }
            resizeCanvas();
            animate();
        });
    }

    // =============================================
    // SISTEMA DE LOGS
    // =============================================
    function addLog(message) {
        if (isPaused) return;
        
        const container = document.getElementById('logContainer');
        const now = new Date();
        const time = now.toLocaleTimeString('es-ES', { 
            hour: '2-digit', 
            minute: '2-digit', 
            second: '2-digit' 
        });
        
        const entry = document.createElement('div');
        entry.textContent = `[${time}] ${message}`;
        
        container.insertBefore(entry, container.firstChild);
        
        // Mantener m√°ximo de entradas
        if (container.children.length > CONFIG.LOG_MAX_ENTRIES) {
            container.removeChild(container.lastChild);
        }
    }

    function togglePause() {
        isPaused = !isPaused;
        const btn = document.getElementById('pauseBtn');
        btn.textContent = isPaused ? 'REANUDAR' : 'PAUSAR';
        btn.classList.toggle('paused', isPaused);
        
        addLog(isPaused ? 'Logs pausados' : 'Logs reanudados');
    }

    // =============================================
    // SISTEMA DE TEMA
    // =============================================
    function initializeTheme() {
        const savedTheme = localStorage.getItem('siena395_theme');
        if (savedTheme === 'dark') {
            document.body.classList.add('dark-mode');
        }
        
        // Actualizar colores del gr√°fico si existe
        if (socChart) {
            updateChartColors();
        }
    }

    function toggleTheme() {
        document.body.classList.toggle('dark-mode');
        
        // Guardar preferencia
        const isDark = document.body.classList.contains('dark-mode');
        localStorage.setItem('siena395_theme', isDark ? 'dark' : 'light');
        
        // Actualizar colores del gr√°fico
        if (socChart) {
            updateChartColors();
        }
        
        addLog(`Tema ${isDark ? 'oscuro' : 'claro'} activado`);
    }

    function updateChartColors() {
        if (!socChart) return;
        
        const isDark = document.body.classList.contains('dark-mode');
        socChart.options.scales.y.ticks.color = isDark ? '#f7fafc' : '#1a202c';
        socChart.update();
    }

    // =============================================
    // MANEJO DE ERRORES Y CERRADO
    // =============================================
    window.addEventListener('beforeunload', function() {
        if (mqttClient && mqttClient.connected) {
            mqttClient.end();
        }
        
        if (flowAnimationId) {
            cancelAnimationFrame(flowAnimationId);
        }
    });

    // Manejo de errores no capturados
    window.addEventListener('error', function(error) {
        console.error('Error no capturado:', error);
        addLog(`Error: ${error.message}`);
    });

</script>
</body>
</html>
