<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SIENA 395 · Logs</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Barlow+Condensed:wght@300;400;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mqtt/4.3.7/mqtt.min.js"></script>
    <style>
        :root {
            --bg: #0a0c0f;
            --surface: #111318;
            --surface2: #181c23;
            --border: #1e2330;
            --text: #c8d0e0;
            --text-dim: #8090b0;
            --text-bright: #eef2ff;
            --accent: #00d4aa;
            --accent-dim: rgba(0,212,170,0.12);
            --ok: #10b981;
            --warn: #f59e0b;
            --danger: #ef4444;
            --info: #3b82f6;
            --radius: 12px;
            --mono: 'Space Mono', monospace;
            --display: 'Barlow Condensed', sans-serif;

            /* Colores por dispositivo */
            --col-bms: #10b981;
            --col-mppt: #ffb020;
            --col-shunt: #3b82f6;
            --col-inversor: #f43f5e;
            --col-orion: #a855f7;
            --col-sense: #06b6d4;
            --col-system: #5a6480;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: var(--display);
            background: var(--bg);
            color: var(--text);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        nav { display: flex; align-items: center; gap: 4px; padding: 12px 16px; background: var(--surface); border-bottom: 1px solid var(--border); flex-shrink: 0; }
        .nav-logo { font-family: var(--mono); font-size: 0.7rem; color: var(--accent); letter-spacing: 2px; margin-right: auto; padding-right: 16px; border-right: 1px solid var(--border); }
        .nav-link { font-family: var(--display); font-weight: 700; font-size: 0.75rem; letter-spacing: 1.5px; text-transform: uppercase; color: var(--text-dim); text-decoration: none; padding: 7px 12px; border-radius: 6px; border: 1px solid transparent; transition: all 0.15s; }
        .nav-link:hover { color: var(--text); background: var(--surface2); }
        .nav-link.active { color: var(--accent); background: var(--accent-dim); border-color: rgba(0,212,170,0.25); }

        .layout {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            max-width: 1000px;
            width: 100%;
            margin: 0 auto;
            padding: 12px 16px;
            gap: 10px;
            min-height: 0;
        }

        /* HEADER BAR */
        .header-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
            flex-shrink: 0;
        }

        .page-title { font-family: var(--display); font-size: 1.8rem; font-weight: 900; letter-spacing: 2px; color: var(--text-bright); line-height: 1; }
        .page-subtitle { font-family: var(--mono); font-size: 0.6rem; color: var(--text-dim); letter-spacing: 2px; }

        .mqtt-pill { font-family: var(--mono); font-size: 0.65rem; letter-spacing: 1px; padding: 6px 12px; border-radius: 20px; background: rgba(239,68,68,0.1); color: var(--danger); border: 1px solid rgba(239,68,68,0.2); display: flex; align-items: center; gap: 6px; }
        .mqtt-pill.connected { background: rgba(16,185,129,0.1); color: var(--ok); border-color: rgba(16,185,129,0.2); }
        .mqtt-dot { width: 6px; height: 6px; border-radius: 50%; background: currentColor; animation: pulse 2s infinite; }
        @keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.3; } }

        /* FILTROS */
        .filter-bar {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            flex-shrink: 0;
        }

        .filter-btn {
            font-family: var(--mono);
            font-size: 0.6rem;
            letter-spacing: 1.5px;
            text-transform: uppercase;
            padding: 6px 12px;
            border-radius: 20px;
            border: 1px solid var(--border);
            background: var(--surface);
            color: var(--text-dim);
            cursor: pointer;
            transition: all 0.15s;
        }

        .filter-btn:hover { color: var(--text-bright); border-color: var(--border-bright); }

        /* Activos por dispositivo — todos con texto blanco visible */
        .filter-btn.active[data-filter="all"] { background: rgba(0,212,170,0.15); color: #00d4aa; border-color: rgba(0,212,170,0.4); }
        .filter-btn.active[data-filter="bms"] { background: rgba(16,185,129,0.15); color: #10b981; border-color: rgba(16,185,129,0.4); }
        .filter-btn.active[data-filter="mppt"] { background: rgba(255,176,32,0.15); color: #ffb020; border-color: rgba(255,176,32,0.4); }
        .filter-btn.active[data-filter="shunt"] { background: rgba(59,130,246,0.15); color: #3b82f6; border-color: rgba(59,130,246,0.4); }
        .filter-btn.active[data-filter="inversor"] { background: rgba(244,63,94,0.15); color: #f43f5e; border-color: rgba(244,63,94,0.4); }
        .filter-btn.active[data-filter="orion"] { background: rgba(168,85,247,0.15); color: #a855f7; border-color: rgba(168,85,247,0.4); }
        .filter-btn.active[data-filter="sense"] { background: rgba(6,182,212,0.15); color: #06b6d4; border-color: rgba(6,182,212,0.4); }

        /* CONSOLA */
        .console-wrap {
            flex: 1;
            background: #060810;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            min-height: 0;
        }

        .console-titlebar {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 14px;
            background: var(--surface);
            border-bottom: 1px solid var(--border);
            flex-shrink: 0;
        }

        .dot { width: 10px; height: 10px; border-radius: 50%; }

        #logConsole {
            flex: 1;
            overflow-y: auto;
            padding: 12px 14px;
            min-height: 0;
            scroll-behavior: smooth;
        }

        #logConsole::-webkit-scrollbar { width: 4px; }
        #logConsole::-webkit-scrollbar-track { background: transparent; }
        #logConsole::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

        .log-line {
            display: flex;
            align-items: baseline;
            gap: 8px;
            padding: 3px 0;
            border-bottom: 1px solid rgba(255,255,255,0.02);
            font-family: var(--mono);
            font-size: 0.72rem;
            line-height: 1.5;
        }

        .log-ts { color: #5a6880; flex-shrink: 0; }

        .log-tag {
            flex-shrink: 0;
            font-size: 0.6rem;
            letter-spacing: 1px;
            padding: 1px 7px;
            border-radius: 3px;
            font-weight: 700;
        }

        /* Tags con fondo y texto siempre legible */
        .tag-bms { background: rgba(16,185,129,0.2); color: #10b981; }
        .tag-mppt { background: rgba(255,176,32,0.2); color: #ffb020; }
        .tag-shunt { background: rgba(59,130,246,0.2); color: #3b82f6; }
        .tag-inversor { background: rgba(244,63,94,0.2); color: #f43f5e; }
        .tag-orion { background: rgba(168,85,247,0.2); color: #a855f7; }
        .tag-sense { background: rgba(6,182,212,0.2); color: #06b6d4; }
        .tag-system { background: rgba(90,100,128,0.2); color: #8090b0; }
        .tag-error { background: rgba(239,68,68,0.2); color: #ef4444; }

        .log-sensor { color: #8898c0; flex-shrink: 0; font-size: 0.65rem; }
        .log-value { color: #c8d0e0; flex: 1; }
        .log-value.val-ok { color: #10b981; }
        .log-value.val-warn { color: #f59e0b; }
        .log-value.val-error { color: #ef4444; }

        /* CONTROLES */
        .controls-bar {
            display: flex;
            gap: 8px;
            padding: 10px 14px;
            background: var(--surface);
            border-top: 1px solid var(--border);
            flex-shrink: 0;
            flex-wrap: wrap;
            align-items: center;
        }

        .ctrl-btn {
            font-family: var(--mono);
            font-size: 0.6rem;
            letter-spacing: 1px;
            padding: 7px 14px;
            border-radius: 6px;
            border: 1px solid var(--border);
            background: var(--surface2);
            color: var(--text-dim);
            cursor: pointer;
            transition: all 0.15s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .ctrl-btn:hover { color: var(--text-bright); border-color: var(--border-bright); }
        .ctrl-btn.danger { border-color: rgba(239,68,68,0.3); color: var(--danger); }
        .ctrl-btn.danger:hover { background: rgba(239,68,68,0.1); }
        .ctrl-btn.ok { border-color: rgba(16,185,129,0.3); color: var(--ok); }
        .ctrl-btn.ok:hover { background: rgba(16,185,129,0.1); }
        .ctrl-btn.paused { border-color: rgba(245,158,11,0.3); color: var(--warn); }

        .stats-row {
            margin-left: auto;
            display: flex;
            gap: 16px;
        }

        .stat-item {
            font-family: var(--mono);
            font-size: 0.6rem;
            color: var(--text-dim);
            letter-spacing: 1px;
        }

        .stat-item span { color: var(--text); }
    </style>
</head>
<body>
    <nav>
        <span class="nav-logo">SIENA·395</span>
        <a href="index.html" class="nav-link">INICIO</a>
        <a href="victron.html" class="nav-link">VICTRON</a>
        <a href="bateria.html" class="nav-link">BATERÍA</a>
        <a href="logs.html" class="nav-link active">LOGS</a>
    </nav>

    <div class="layout">
        <div class="header-bar">
            <div>
                <div class="page-title">CONSOLA</div>
                <div class="page-subtitle">MQTT REAL-TIME · mi_clave_privada_siena/#</div>
            </div>
            <div class="mqtt-pill" id="mqttStatus">
                <div class="mqtt-dot"></div>DESCONECTADO
            </div>
        </div>

        <div class="filter-bar" id="filterBar">
            <button class="filter-btn active" data-filter="all">TODOS</button>
            <button class="filter-btn" data-filter="bms">BMS</button>
            <button class="filter-btn" data-filter="mppt">MPPT</button>
            <button class="filter-btn" data-filter="shunt">SHUNT</button>
            <button class="filter-btn" data-filter="inversor">INVERSOR</button>
            <button class="filter-btn" data-filter="orion">ORION</button>
            <button class="filter-btn" data-filter="sense">SENSE</button>
        </div>

        <div class="console-wrap">
            <div class="console-titlebar">
                <div class="dot" style="background:#ef4444;"></div>
                <div class="dot" style="background:#f59e0b;"></div>
                <div class="dot" style="background:#10b981;"></div>
                <span style="font-family:var(--mono); font-size:0.6rem; color:var(--text-dim); margin-left:8px; letter-spacing:1px;">
                    SIENA-395-MQTT-CONSOLE
                </span>
            </div>

            <div id="logConsole">
                <div class="log-line">
                    <span class="log-ts">--:--:--</span>
                    <span class="log-tag tag-system">SYS</span>
                    <span class="log-value">Consola iniciada. Conectando al broker MQTT...</span>
                </div>
            </div>

            <div class="controls-bar">
                <button class="ctrl-btn danger" onclick="clearLogs()">
                    <i class="fas fa-trash"></i> LIMPIAR
                </button>
                <button class="ctrl-btn" id="pauseBtn" onclick="togglePause()">
                    <i class="fas fa-pause"></i> PAUSAR
                </button>
                <button class="ctrl-btn ok" onclick="exportLogs()">
                    <i class="fas fa-download"></i> EXPORTAR
                </button>
                <button class="ctrl-btn" onclick="scrollBottom()">
                    <i class="fas fa-arrow-down"></i> FIN
                </button>

                <div class="stats-row">
                    <div class="stat-item">MSG: <span id="msgCount">0</span></div>
                    <div class="stat-item">FILTRO: <span id="activeFilter">TODOS</span></div>
                    <div class="stat-item">ÚLT: <span id="lastUpdate">--:--:--</span></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const BROKER = 'wss://broker.emqx.io:8084/mqtt';
        const mqttStatusEl = document.getElementById('mqttStatus');
        const consoleEl = document.getElementById('logConsole');

        let isPaused = false;
        let msgCount = 0;
        let currentFilter = 'all';
        let logHistory = [];
        const MAX_LOGS = 500;

        const client = mqtt.connect(BROKER, { clientId: 'siena_logs_' + Math.random().toString(16).substr(2,8) });

        client.on('connect', () => {
            mqttStatusEl.innerHTML = '<div class="mqtt-dot"></div>CONECTADO';
            mqttStatusEl.className = 'mqtt-pill connected';
            client.subscribe('mi_clave_privada_siena/sensor/#');
            client.subscribe('mi_clave_privada_siena/binary_sensor/#');
            addSystemLine('Conectado al broker EMQX · Suscrito a sensor/# y binary_sensor/#');
        });

        client.on('error', (err) => {
            mqttStatusEl.innerHTML = '<div class="mqtt-dot"></div>ERROR';
            addSystemLine('Error MQTT: ' + err.message, 'error');
        });

        client.on('offline', () => {
            mqttStatusEl.innerHTML = '<div class="mqtt-dot"></div>DESCONECTADO';
            mqttStatusEl.className = 'mqtt-pill';
            addSystemLine('Desconectado del broker', 'warn');
        });

        client.on('reconnect', () => {
            addSystemLine('Reconectando...', 'warn');
        });

        client.on('message', (topic, msg) => {
            if (isPaused) return;

            const payload = msg.toString();
            const parts = topic.split('/');
            const sensorName = parts[2] || '';
            const deviceType = getDeviceType(sensorName);
            const ts = new Date().toLocaleTimeString('es-ES',{hour:'2-digit',minute:'2-digit',second:'2-digit'});

            document.getElementById('lastUpdate').innerText = ts;
            msgCount++;
            document.getElementById('msgCount').innerText = msgCount;

            const entry = { ts, sensorName, deviceType, payload, topic };
            logHistory.push(entry);
            if (logHistory.length > MAX_LOGS) logHistory.shift();

            if (currentFilter === 'all' || currentFilter === deviceType) {
                renderLine(entry);
            }
        });

        function getDeviceType(name) {
            if (name.includes('bms')) return 'bms';
            if (name.includes('mppt')) return 'mppt';
            if (name.includes('shunt')) return 'shunt';
            if (name.includes('inversor')) return 'inversor';
            if (name.includes('orion')) return 'orion';
            if (name.includes('sense')) return 'sense';
            return 'system';
        }

        function getTagClass(type) {
            const map = { bms:'tag-bms', mppt:'tag-mppt', shunt:'tag-shunt', inversor:'tag-inversor', orion:'tag-orion', sense:'tag-sense', system:'tag-system' };
            return map[type] || 'tag-system';
        }

        function getValueClass(sensorName, payload) {
            if (payload === 'nan' || sensorName.includes('error') || sensorName.includes('fallo')) return 'val-error';
            if (sensorName.includes('soc') || sensorName.includes('temperatura')) {
                const v = parseFloat(payload);
                if (sensorName.includes('soc') && v < 20) return 'val-warn';
                if (sensorName.includes('temperatura') && v > 40) return 'val-warn';
            }
            return '';
        }

        function renderLine(entry) {
            const div = document.createElement('div');
            div.className = 'log-line';
            div.setAttribute('data-device', entry.deviceType);

            const tagLabel = entry.deviceType.toUpperCase();
            const valClass = getValueClass(entry.sensorName, entry.payload);

            div.innerHTML = `
                <span class="log-ts">${entry.ts}</span>
                <span class="log-tag ${getTagClass(entry.deviceType)}">${tagLabel}</span>
                <span class="log-sensor">${entry.sensorName}</span>
                <span class="log-value ${valClass}">${entry.payload}</span>
            `;

            consoleEl.appendChild(div);

            // Limitar DOM a 300 líneas visibles
            while (consoleEl.children.length > 300) {
                consoleEl.removeChild(consoleEl.firstChild);
            }

            consoleEl.scrollTop = consoleEl.scrollHeight;
        }

        function addSystemLine(msg, type = 'info') {
            const ts = new Date().toLocaleTimeString('es-ES',{hour:'2-digit',minute:'2-digit',second:'2-digit'});
            const div = document.createElement('div');
            div.className = 'log-line';
            div.setAttribute('data-device', 'system');
            const cls = type === 'error' ? 'val-error' : type === 'warn' ? 'val-warn' : 'val-ok';
            div.innerHTML = `
                <span class="log-ts">${ts}</span>
                <span class="log-tag tag-system">SYS</span>
                <span class="log-value ${cls}">${msg}</span>
            `;
            consoleEl.appendChild(div);
            consoleEl.scrollTop = consoleEl.scrollHeight;
        }

        // FILTROS
        document.getElementById('filterBar').addEventListener('click', (e) => {
            const btn = e.target.closest('.filter-btn');
            if (!btn) return;

            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            currentFilter = btn.getAttribute('data-filter');
            document.getElementById('activeFilter').innerText = btn.innerText;

            // Redibujar con el filtro
            consoleEl.innerHTML = '';
            logHistory.forEach(entry => {
                if (currentFilter === 'all' || currentFilter === entry.deviceType) {
                    renderLine(entry);
                }
            });

            addSystemLine('Filtro: ' + btn.innerText);
        });

        function clearLogs() {
            consoleEl.innerHTML = '';
            logHistory = [];
            msgCount = 0;
            document.getElementById('msgCount').innerText = 0;
            addSystemLine('Consola limpiada');
        }

        function togglePause() {
            isPaused = !isPaused;
            const btn = document.getElementById('pauseBtn');
            if (isPaused) {
                btn.innerHTML = '<i class="fas fa-play"></i> REANUDAR';
                btn.classList.add('paused');
                addSystemLine('Consola pausada', 'warn');
            } else {
                btn.innerHTML = '<i class="fas fa-pause"></i> PAUSAR';
                btn.classList.remove('paused');
                addSystemLine('Consola reanudada');
            }
        }

        function exportLogs() {
            let text = 'SIENA 395 - EXPORT MQTT LOGS\n';
            text += new Date().toISOString() + '\n';
            text += '='.repeat(60) + '\n\n';
            logHistory.forEach(e => {
                text += `[${e.ts}] [${e.deviceType.toUpperCase()}] ${e.sensorName}: ${e.payload}\n`;
            });
            const blob = new Blob([text], {type:'text/plain'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `siena-logs-${new Date().toISOString().slice(0,16).replace(/[T:]/g,'-')}.txt`;
            a.click();
            URL.revokeObjectURL(url);
            addSystemLine('Exportado ' + logHistory.length + ' líneas');
        }

        function scrollBottom() {
            consoleEl.scrollTop = consoleEl.scrollHeight;
        }
    </script>
</body>
</html>
